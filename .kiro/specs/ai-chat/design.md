# Design Document

## Overview

**Purpose**: ä¸å‹•ç”£åº—èˆ—ã«è¨­ç½®ã™ã‚‹AIæ¥å®¢ã‚­ã‚ªã‚¹ã‚¯ã€‚é¡§å®¢ã¯ä¼šè©±ã ã‘ã§ç‰©ä»¶æ¤œç´¢ã‹ã‚‰å†…è¦‹äºˆç´„ã¾ã§å®Œçµã—ã€é€£çµ¡å…ˆã‚’å…¥åŠ›ã—ã¦çµ‚äº†ã™ã‚‹ã€‚

**Users**: åº—èˆ—æ¥åº—å®¢ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ã€èªè¨¼ä¸è¦ï¼‰

**Impact**: å–¶æ¥­æ‹…å½“è€…ä¸åœ¨æ™‚ã‚‚24æ™‚é–“é¡§å®¢å¯¾å¿œãŒå¯èƒ½ã«ãªã‚Šã€æ©Ÿä¼šæå¤±ã‚’é˜²ãã€‚

### Goals
- ä¼šè©±ã®ã¿ã§ç‰©ä»¶æ¤œç´¢ã€œå†…è¦‹äºˆç´„ã€œé€£çµ¡å…ˆåé›†ã‚’å®Œçµ
- é«˜é½¢è€…ã«ã‚‚ä½¿ã„ã‚„ã™ã„éŸ³å£°å¯¾è©±ï¼ˆéŸ³å£°å…¥åŠ›ãƒœã‚¿ãƒ³ã‚’ç”»é¢ä¸­å¤®ã«å¤§ããé…ç½®ï¼‰
- æ®µéšçš„ãªæ¡ä»¶ãƒ’ã‚¢ãƒªãƒ³ã‚°ï¼ˆä¸€åº¦ã«å…¨æ¡ä»¶ã‚’è¨€ãˆãªãã¦ã‚‚OKï¼‰
- ç‰©ä»¶ã‚¹ãƒ­ãƒƒãƒˆUIã§å€™è£œç‰©ä»¶ã‚’å¯è¦–åŒ–
- ã‚·ãƒ³ãƒ—ãƒ«ãª1ç”»é¢UI
- ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†å¾Œã®è‡ªå‹•ãƒªã‚»ãƒƒãƒˆ

### Non-Goals
- é¡§å®¢ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†
- é¡§å®¢å‘ã‘ã®è¨­å®šç”»é¢
- ä¼šè©±å±¥æ­´ã®é¡§å®¢å‘ã‘é–²è¦§æ©Ÿèƒ½
- å¥‘ç´„ãƒ»æ±ºæ¸ˆå‡¦ç†

## Architecture

### System Components

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº—èˆ—è¨­ç½®ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ/PC                         â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    KioskInterface                           â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚             â”‚  â”‚         ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆ              â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  ã‚¢ãƒã‚¿ãƒ¼    â”‚  â”‚                                      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  (æ„Ÿæƒ…è¡¨ç¾)  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”‚
â”‚  â”‚  â”‚             â”‚  â”‚     ç‰©ä»¶ã‚¹ãƒ­ãƒƒãƒˆï¼ˆå€™è£œç‰©ä»¶è¡¨ç¤ºï¼‰       â”‚ â”‚ â”‚
â”‚  â”‚  â”‚             â”‚  â”‚  [ç‰©ä»¶1] [ç‰©ä»¶2] [ç‰©ä»¶3] ...          â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚  â”‚  â”‚                                                         â”‚â”‚ â”‚
â”‚  â”‚  â”‚              [  ğŸ¤  å¤§ããªéŸ³å£°ãƒœã‚¿ãƒ³  ]                 â”‚â”‚ â”‚
â”‚  â”‚  â”‚                                                         â”‚â”‚ â”‚
â”‚  â”‚  â”‚  [___ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›___] [é€ä¿¡]                  [çµ‚äº†]    â”‚â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ContactForm (å†…è¦‹äºˆç´„ç¢ºå®šæ™‚ã®ã¿è¡¨ç¤º)                       â”‚ â”‚
â”‚  â”‚  åå‰: [________] é›»è©±: [________] ãƒ¡ãƒ¼ãƒ«: [________]       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Next.js API Routes                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ /api/kiosk/ â”‚  â”‚ /api/voice/ â”‚  â”‚ /api/kiosk/complete     â”‚   â”‚
â”‚  â”‚ chat        â”‚  â”‚ transcribe  â”‚  â”‚ (äºˆç´„ç¢ºå®š+é¡§å®¢ç™»éŒ²)     â”‚   â”‚
â”‚  â”‚             â”‚  â”‚ synthesize  â”‚  â”‚                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                   â”‚                   â”‚
          â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Google        â”‚ â”‚   Supabase      â”‚ â”‚   Resend                â”‚
â”‚   Gemini 2.5    â”‚ â”‚   Database      â”‚ â”‚   ãƒ¡ãƒ¼ãƒ«é€ä¿¡            â”‚
â”‚   Flash         â”‚ â”‚   (èªè¨¼ãªã—)    â”‚ â”‚                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚                 â”‚ â”‚                         â”‚
â”‚   OpenAI        â”‚ â”‚                 â”‚ â”‚                         â”‚
â”‚   Whisper       â”‚ â”‚                 â”‚ â”‚                         â”‚
â”‚   Embeddings    â”‚ â”‚                 â”‚ â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Technology Stack

| Layer | Choice | Role |
|-------|--------|------|
| Frontend | React 19 + Next.js 15 | ã‚­ã‚ªã‚¹ã‚¯UI |
| AI Chat | Vercel AI SDK + Gemini 2.5 Flash | ä¼šè©±ç”Ÿæˆã€Function Calling |
| Voice | OpenAI Whisper + Google Cloud TTS | éŸ³å£°å…¥å‡ºåŠ› |
| Database | Supabase (Service Role) | ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆèªè¨¼ãªã—ï¼‰ |
| Email | Resend | ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡ |
| State | Zustand | ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ç®¡ç† |

## System Flows

### ãƒ¡ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼

```mermaid
stateDiagram-v2
    [*] --> Welcome: ç”»é¢ã‚¢ã‚¯ã‚»ã‚¹
    Welcome --> Conversation: AIæŒ¨æ‹¶
    Conversation --> Conversation: ç‰©ä»¶æ¤œç´¢ãƒ»ææ¡ˆ
    Conversation --> ContactForm: å†…è¦‹äºˆç´„ç¢ºå®š
    Conversation --> Goodbye: çµ‚äº†ãƒœã‚¿ãƒ³
    ContactForm --> Complete: é€£çµ¡å…ˆå…¥åŠ›å®Œäº†
    Complete --> Welcome: è‡ªå‹•ãƒªã‚»ãƒƒãƒˆ
    Goodbye --> Welcome: è‡ªå‹•ãƒªã‚»ãƒƒãƒˆ

    note right of Conversation
        - æ¡ä»¶ãƒ’ã‚¢ãƒªãƒ³ã‚°
        - ç‰©ä»¶æ¤œç´¢
        - ç‰©ä»¶ææ¡ˆ
        - å†…è¦‹äºˆç´„èª¿æ•´
    end note
```

### ä¼šè©±ãƒ•ãƒ­ãƒ¼è©³ç´°

```mermaid
sequenceDiagram
    participant C as é¡§å®¢
    participant UI as KioskUI
    participant API as /api/kiosk/chat
    participant GPT as GPT-4o
    participant DB as Supabase

    Note over UI: åˆæœŸç”»é¢è¡¨ç¤º
    UI->>UI: AIæŒ¨æ‹¶ã€Œã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€
    UI->>UI: éŸ³å£°èª­ã¿ä¸Šã’

    C->>UI: ã€Œ2LDKã‚’æ¢ã—ã¦ã¾ã™ã€(éŸ³å£°/ãƒ†ã‚­ã‚¹ãƒˆ)
    UI->>API: POST (message)
    API->>GPT: streamText + tools

    GPT->>API: ãƒ’ã‚¢ãƒªãƒ³ã‚°å¿œç­”
    API-->>UI: SSE
    UI->>UI: è¡¨ç¤º + éŸ³å£°èª­ã¿ä¸Šã’

    Note over C,UI: æ¡ä»¶ãƒ’ã‚¢ãƒªãƒ³ã‚°ç¹°ã‚Šè¿”ã—

    GPT->>API: searchProperties()
    API->>DB: ç‰©ä»¶æ¤œç´¢
    DB-->>API: ç‰©ä»¶ãƒªã‚¹ãƒˆ
    API->>GPT: æ¤œç´¢çµæœ
    GPT-->>API: ç‰©ä»¶ææ¡ˆå¿œç­”
    API-->>UI: ç‰©ä»¶ã‚«ãƒ¼ãƒ‰ + èª¬æ˜

    C->>UI: ã€Œã“ã®ç‰©ä»¶ã‚’è¦‹ãŸã„ã€
    UI->>API: POST
    GPT->>API: bookViewing()
    GPT-->>UI: äºˆç´„ç¢ºèª

    C->>UI: ã€Œæ¥é€±ã®åœŸæ›œæ—¥ã€
    GPT-->>UI: äºˆç´„ç¢ºå®šã€é€£çµ¡å…ˆå…¥åŠ›ã‚’ä¿ƒã™
    UI->>UI: ContactFormè¡¨ç¤º
```

### äºˆç´„å®Œäº†ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant C as é¡§å®¢
    participant UI as ContactForm
    participant API as /api/kiosk/complete
    participant DB as Supabase
    participant Email as Resend

    C->>UI: é€£çµ¡å…ˆå…¥åŠ›
    UI->>UI: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    C->>UI: é€ä¿¡
    UI->>API: POST (é¡§å®¢æƒ…å ± + äºˆç´„æƒ…å ±)

    API->>DB: customers INSERT
    API->>DB: viewings INSERT
    API->>DB: conversations UPDATE

    par ãƒ¡ãƒ¼ãƒ«é€ä¿¡
        API->>Email: é¡§å®¢ç¢ºèªãƒ¡ãƒ¼ãƒ«
        API->>Email: ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼é€šçŸ¥ãƒ¡ãƒ¼ãƒ«
    end

    API-->>UI: å®Œäº†
    UI->>UI: å®Œäº†ç”»é¢è¡¨ç¤º

    Note over UI: 30ç§’å¾Œè‡ªå‹•ãƒªã‚»ãƒƒãƒˆ
    UI->>UI: Welcomeç”»é¢ã¸
```

## Components and Interfaces

### Frontend Components

#### KioskInterface
| Field | Detail |
|-------|--------|
| Intent | ã‚­ã‚ªã‚¹ã‚¯å…¨ä½“ã®ã‚³ãƒ³ãƒ†ãƒŠ |
| Requirements | 1, 5, 7 |

**çŠ¶æ…‹ç®¡ç†**
```typescript
interface KioskState {
  phase: 'welcome' | 'conversation' | 'contact' | 'complete' | 'goodbye';
  sessionId: string;
  messages: Message[];
  // ç‰©ä»¶ã‚¹ãƒ­ãƒƒãƒˆ: ä¼šè©±ã§è¿½åŠ /çµã‚Šè¾¼ã¿ã•ã‚Œã‚‹å€™è£œç‰©ä»¶ãƒªã‚¹ãƒˆ
  propertySlots: Property[];
  selectedProperty: Property | null;
  viewingDate: Date | null;
  // æ®µéšçš„ã«åé›†ã•ã‚Œã‚‹æ¡ä»¶
  collectedCriteria: {
    areas?: string[];
    budgetMin?: number;
    budgetMax?: number;
    layouts?: string[];
    buildingTypes?: string[];
    stations?: string[];
    amenities?: string[];
  };
}
```

#### AvatarDisplay
| Field | Detail |
|-------|--------|
| Intent | AIã‚¢ãƒã‚¿ãƒ¼ã¨æ„Ÿæƒ…è¡¨ç¾ |
| Requirements | 6 |

#### ConversationPanel
| Field | Detail |
|-------|--------|
| Intent | ä¼šè©±å±¥æ­´ã¨ç‰©ä»¶ã‚«ãƒ¼ãƒ‰è¡¨ç¤º |
| Requirements | 1, 2 |

#### PropertySlots
| Field | Detail |
|-------|--------|
| Intent | å€™è£œç‰©ä»¶ã®ã‚¹ãƒ­ãƒƒãƒˆè¡¨ç¤ºï¼ˆè¿½åŠ ãƒ»çµã‚Šè¾¼ã¿ï¼‰ |
| Requirements | 2 |

**Props**
```typescript
interface PropertySlotsProps {
  properties: Property[];
  selectedId: string | null;
  onSelect: (property: Property) => void;
  onRemove: (propertyId: string) => void;
}
```

**å‹•ä½œ**
- AIãŒç‰©ä»¶ã‚’æ¤œç´¢ã™ã‚‹ã¨ã€ã‚¹ãƒ­ãƒƒãƒˆã«ç‰©ä»¶ãŒè¿½åŠ ã•ã‚Œã‚‹
- é¡§å®¢ãŒæ¡ä»¶ã‚’è¿½åŠ ã™ã‚‹ã¨ã€ã‚¹ãƒ­ãƒƒãƒˆå†…ã®ç‰©ä»¶ãŒçµã‚Šè¾¼ã¾ã‚Œã‚‹
- é¡§å®¢ãŒç‰©ä»¶ã‚’é¸æŠã™ã‚‹ã¨ã€AIãŒãã®ç‰©ä»¶ã«ã¤ã„ã¦è©³ã—ãèª¬æ˜ã™ã‚‹
- æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªã‚«ãƒ«ãƒ¼ã‚»ãƒ«å½¢å¼ã§è¡¨ç¤º

#### VoiceInput
| Field | Detail |
|-------|--------|
| Intent | éŸ³å£°éŒ²éŸ³ã¨ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ› |
| Requirements | 1 |

#### ContactForm
| Field | Detail |
|-------|--------|
| Intent | é€£çµ¡å…ˆå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  |
| Requirements | 4 |

**Fields**
```typescript
interface ContactFormData {
  name: string;
  phone: string;
  email: string;
}
```

#### CompletionScreen
| Field | Detail |
|-------|--------|
| Intent | äºˆç´„å®Œäº†ç”»é¢ |
| Requirements | 5 |

### API Routes

#### POST /api/kiosk/chat

èªè¨¼ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªã‚­ã‚ªã‚¹ã‚¯å°‚ç”¨ãƒãƒ£ãƒƒãƒˆAPI

**Request**
```typescript
interface KioskChatRequest {
  session_id: string;
  operator_id: string;  // åº—èˆ—è­˜åˆ¥ç”¨ï¼ˆURLç­‰ã‹ã‚‰å–å¾—ï¼‰
  message: string;
  context?: {
    selected_property_id?: string;
    viewing_date?: string;
  };
}
```

**Response**: SSE Stream
```
data: {"type":"text","content":"..."}
data: {"type":"emotion","emotion":"happy"}
data: {"type":"criteria_update","criteria":{...}}
data: {"type":"properties_add","properties":[...]}
data: {"type":"properties_refine","property_ids":[...]}
data: {"type":"property_select","property":{...}}
data: {"type":"booking_confirm","property_id":"...","date":"..."}
data: {"type":"request_contact"}
data: {"type":"done"}
```

**ä¼šè©±ãƒ‘ã‚¿ãƒ¼ãƒ³ä¾‹**
```
é¡§å®¢: ã€Œæ–‡äº¬åŒºã§æ¢ã—ã¦ã¾ã™ã€
AI: [addPropertyCriteria] â†’ ç‰©ä»¶ã‚¹ãƒ­ãƒƒãƒˆã«æ–‡äº¬åŒºã®ç‰©ä»¶ã‚’è¿½åŠ 
AI: ã€Œæ–‡äº¬åŒºã§ã™ã­ã€‚ã”äºˆç®—ã¯ã„ãã‚‰ãã‚‰ã„ã‚’ãŠè€ƒãˆã§ã™ã‹ï¼Ÿã€

é¡§å®¢: ã€Œ15ä¸‡å††ãã‚‰ã„ã¾ã§ã§ã€
AI: [refineCriteria] â†’ 15ä¸‡å††ä»¥ä¸‹ã«çµã‚Šè¾¼ã¿
AI: ã€Œ15ä¸‡å††ä»¥ä¸‹ã§ã™ã¨ã€ã“ã¡ã‚‰ã®5ä»¶ãŒã”ã–ã„ã¾ã™ã€‚é–“å–ã‚Šã®ã”å¸Œæœ›ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿã€

é¡§å®¢: ã€Œ2LDKãŒã„ã„ãªã€
AI: [refineCriteria] â†’ 2LDKã«çµã‚Šè¾¼ã¿
AI: ã€Œ2LDKã§ã™ã¨3ä»¶ã”ã–ã„ã¾ã™ã€‚ã“ã¡ã‚‰ã®é§…è¿‘ç‰©ä»¶ã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã‹ï¼Ÿã€

é¡§å®¢: (ç‰©ä»¶ã‚¹ãƒ­ãƒƒãƒˆã‹ã‚‰ç‰©ä»¶ã‚’é¸æŠ)
AI: [selectProperty] â†’ è©³ç´°ã‚’è¡¨ç¤º
AI: ã€Œã“ã¡ã‚‰ã¯èŒ—è·è°·é§…ã‹ã‚‰å¾’æ­©5åˆ†ã®ç¯‰æµ…ãƒãƒ³ã‚·ãƒ§ãƒ³ã§ã™...ã€
```

#### POST /api/kiosk/complete

äºˆç´„ç¢ºå®šã¨é¡§å®¢æƒ…å ±ç™»éŒ²

**Request**
```typescript
interface CompleteRequest {
  session_id: string;
  operator_id: string;
  customer: {
    name: string;
    phone: string;
    email: string;
  };
  viewing: {
    property_id: string;
    viewing_date: string;
  };
}
```

**Response**
```json
{
  "success": true,
  "data": {
    "customer_id": "uuid",
    "viewing_id": "uuid",
    "message": "ã”äºˆç´„ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™"
  }
}
```

### AI Tools (Function Calling)

```typescript
const kioskTools = {
  // æ¡ä»¶ã‚’è¿½åŠ ã—ã¦ç‰©ä»¶ã‚¹ãƒ­ãƒƒãƒˆã«è¿½åŠ 
  addPropertyCriteria: {
    description: 'é¡§å®¢ã®å¸Œæœ›æ¡ä»¶ã‚’è¿½åŠ ã—ã€ãƒãƒƒãƒã™ã‚‹ç‰©ä»¶ã‚’ã‚¹ãƒ­ãƒƒãƒˆã«è¿½åŠ ',
    parameters: z.object({
      areas: z.array(z.string()).optional(),
      rent_min: z.number().optional(),
      rent_max: z.number().optional(),
      layouts: z.array(z.string()).optional(),
      building_types: z.array(z.string()).optional(),
      stations: z.array(z.string()).optional(),
      amenities: z.array(z.string()).optional(),
    }),
  },

  // æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ã‚¹ãƒ­ãƒƒãƒˆå†…ã®ç‰©ä»¶ã‚’çµã‚Šè¾¼ã¿
  refineCriteria: {
    description: 'æ—¢å­˜ã®æ¡ä»¶ã‚’å¤‰æ›´ã—ã€ã‚¹ãƒ­ãƒƒãƒˆå†…ã®ç‰©ä»¶ã‚’çµã‚Šè¾¼ã‚€',
    parameters: z.object({
      areas: z.array(z.string()).optional(),
      rent_min: z.number().optional(),
      rent_max: z.number().optional(),
      layouts: z.array(z.string()).optional(),
      building_types: z.array(z.string()).optional(),
      stations: z.array(z.string()).optional(),
      amenities: z.array(z.string()).optional(),
    }),
  },

  // ã‚¹ãƒ­ãƒƒãƒˆã‹ã‚‰ç‰©ä»¶ã‚’é¸æŠã—ã¦è©³ç´°ã‚’è¡¨ç¤º
  selectProperty: {
    description: 'ç‰©ä»¶ã‚’é¸æŠã—ã¦è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º',
    parameters: z.object({
      property_id: z.string(),
    }),
  },

  // å†…è¦‹äºˆç´„ã‚’ææ¡ˆ
  proposeViewing: {
    description: 'é¸æŠä¸­ã®ç‰©ä»¶ã®å†…è¦‹äºˆç´„ã‚’ææ¡ˆ',
    parameters: z.object({
      property_id: z.string(),
    }),
  },

  // å†…è¦‹äºˆç´„ã‚’ç¢ºå®šï¼ˆé€£çµ¡å…ˆå…¥åŠ›ã‚’ä¿ƒã™ï¼‰
  confirmViewing: {
    description: 'å†…è¦‹äºˆç´„ã‚’ç¢ºå®šï¼ˆé€£çµ¡å…ˆå…¥åŠ›ã‚’ä¿ƒã™ï¼‰',
    parameters: z.object({
      property_id: z.string(),
      viewing_date: z.string(),
    }),
  },
};
```

## Data Models

### Session (ä¸€æ™‚çš„)
```typescript
interface KioskSession {
  id: string;
  operator_id: string;
  started_at: Date;
  messages: Message[];
  selected_property?: Property;
  viewing_date?: Date;
  customer?: Customer;
  status: 'active' | 'completed' | 'abandoned';
}
```

### Conversation (DBä¿å­˜)
```typescript
interface Conversation {
  id: string;
  operator_id: string;
  customer_id?: string;  // é€£çµ¡å…ˆå…¥åŠ›å¾Œã«è¨­å®š
  session_type: 'kiosk';
  started_at: Date;
  ended_at?: Date;
  outcome: 'viewing_booked' | 'browsing_only' | 'abandoned';
}
```

## Security Considerations

- **èªè¨¼ãªã—**: ã‚­ã‚ªã‚¹ã‚¯ç«¯æœ«ã¯èªè¨¼ä¸è¦ï¼ˆService Role Keyä½¿ç”¨ï¼‰
- **operator_id**: URL/ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ã—ã€ãƒ‡ãƒ¼ã‚¿åˆ†é›¢
- **ãƒ¬ãƒ¼ãƒˆåˆ¶é™**: IP + session_idã§ãƒ¬ãƒ¼ãƒˆåˆ¶é™
- **å…¥åŠ›ã‚µãƒ‹ã‚¿ã‚¤ã‚º**: é›»è©±ç•ªå·ãƒ»ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- **ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: 10åˆ†æ“ä½œãªã—ã§ãƒªã‚»ãƒƒãƒˆ

## Error Handling

### ä¼šè©±ã‚¨ãƒ©ãƒ¼
- Gemini APIã‚¨ãƒ©ãƒ¼ â†’ ã€Œç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€ã‚‚ã†ä¸€åº¦ãŠè©±ã—ãã ã•ã„ã€
- ç‰©ä»¶æ¤œç´¢0ä»¶ â†’ æ¡ä»¶ç·©å’Œã‚’ææ¡ˆ

### ãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒ©ãƒ¼
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ â†’ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚¤ãƒ©ã‚¤ãƒˆ
- é€ä¿¡å¤±æ•— â†’ ãƒªãƒˆãƒ©ã‚¤ãƒœã‚¿ãƒ³

## Testing Strategy

### Unit Tests
- ContactForm: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- AI Tools: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ¤œè¨¼

### Integration Tests
- ä¼šè©±ãƒ•ãƒ­ãƒ¼å…¨ä½“
- äºˆç´„å®Œäº†ãƒ•ãƒ­ãƒ¼

### E2E Tests
- åˆæœŸç”»é¢ â†’ ç‰©ä»¶æ¤œç´¢ â†’ å†…è¦‹äºˆç´„ â†’ é€£çµ¡å…ˆå…¥åŠ› â†’ å®Œäº† â†’ ãƒªã‚»ãƒƒãƒˆ

## Performance Considerations

- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 10åˆ†
- å®Œäº†ç”»é¢è‡ªå‹•ãƒªã‚»ãƒƒãƒˆ: 30ç§’
- éŸ³å£°ã‚­ãƒ£ãƒƒã‚·ãƒ¥: ã‚ˆãä½¿ã†ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
