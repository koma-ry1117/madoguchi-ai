feature: viewing-reservation
title: 内見予約管理実装タスク

tasks:
  - id: 1
    title: データベーススキーマとマイグレーション実装
    requirements: [1.1, 1.2, 1.3, 1.4, 4.2]
    subtasks:
      - id: "1.1"
        priority: true
        title: viewingsテーブルマイグレーション作成
        files:
          - path: supabase/migrations/{timestamp}_create_viewings_table.sql
            action: create
        details:
          - カラム定義（id, customer_id, property_id, operator_id等）
          - status列CHECK制約
          - FK制約、インデックス作成
        status: pending
      - id: "1.2"
        priority: true
        title: customersテーブルsource列追加
        files:
          - path: supabase/migrations/{timestamp}_add_customers_source.sql
            action: create
        details:
          - source列追加（kiosk, web, manual）
          - 既存データにデフォルト値設定
        status: pending
      - id: "1.3"
        priority: true
        title: RLSポリシー設定
        details:
          - オペレーター向けポリシー（自社予約のみ）
          - SELECT, INSERT, UPDATE, DELETE各ポリシー
        status: pending
      - id: "1.4"
        priority: true
        title: マイグレーションのローカルテスト
        details:
          - supabase db resetでマイグレーション適用
          - テストデータ投入
          - RLS動作確認
        status: pending

  - id: 2
    title: Zodスキーマとデータ型定義
    requirements: [1.1, 1.2, 1.3, 1.4, 4.2]
    subtasks:
      - id: "2.1"
        priority: true
        title: Viewingスキーマ定義
        files:
          - path: src/schemas/viewing.ts
            action: create
        details:
          - createViewingSchema
          - updateViewingSchema
          - cancelViewingSchema
          - ViewingStatus型export
        status: pending
      - id: "2.2"
        priority: true
        title: 型定義の生成と拡張
        files:
          - path: src/types/database.ts
            action: modify
        details:
          - ViewingWithDetails型定義
          - ViewingFilters型定義
        status: pending

  - id: 3
    title: ICSファイル生成ユーティリティ
    requirements: [2.3]
    subtasks:
      - id: "3.1"
        title: ICS Generator実装
        files:
          - path: src/lib/email/utils/generate-ics.ts
            action: create
        details:
          - ical-generatorパッケージ使用
          - generateViewingICS()関数実装
          - タイムゾーン（Asia/Tokyo）設定
        status: pending
      - id: "3.2"
        title: ICS Generator単体テスト
        files:
          - path: src/lib/email/utils/__tests__/generate-ics.test.ts
            action: create
        status: pending

  - id: 4
    title: React Emailテンプレート実装
    requirements: [2.1, 2.2, 2.4, 4.3, 5.1, 5.2, 5.3]
    subtasks:
      - id: "4.1"
        priority: true
        title: 予約確認メールテンプレート
        files:
          - path: src/lib/email/templates/ViewingConfirmationEmail.tsx
            action: create
        status: pending
      - id: "4.2"
        priority: true
        title: オペレーター通知メールテンプレート
        files:
          - path: src/lib/email/templates/ViewingNotificationEmail.tsx
            action: create
        status: pending
      - id: "4.3"
        priority: true
        title: リマインダーメールテンプレート
        files:
          - path: src/lib/email/templates/ViewingReminderEmail.tsx
            action: create
        status: pending
      - id: "4.4"
        priority: true
        title: キャンセル通知メールテンプレート
        files:
          - path: src/lib/email/templates/ViewingCancellationEmail.tsx
            action: create
        status: pending
      - id: "4.5"
        priority: true
        title: メールテンプレートのプレビュー設定
        status: pending

  - id: 5
    title: ViewingServiceの実装
    requirements: [1.1, 1.2, 1.3, 1.4, 3.1, 3.2, 3.3, 3.4, 3.5, 4.1, 4.2, 4.3]
    files:
      - path: src/lib/services/viewing-service.ts
        action: create
    subtasks:
      - id: "5.1"
        title: ViewingServiceクラス作成
        status: pending
      - id: "5.2"
        title: 予約作成メソッド
        status: pending
      - id: "5.3"
        title: 予約一覧取得メソッド
        status: pending
      - id: "5.4"
        title: 予約詳細取得メソッド
        status: pending
      - id: "5.5"
        title: 予約更新メソッド
        status: pending
      - id: "5.6"
        title: 予約キャンセルメソッド
        status: pending
      - id: "5.7"
        title: 会話履歴取得メソッド
        status: pending
      - id: "5.8"
        title: ViewingService単体テスト
        files:
          - path: src/lib/services/__tests__/viewing-service.test.ts
            action: create
        status: pending

  - id: 6
    title: メール送信処理の実装
    requirements: [2.1, 2.2, 2.3, 2.4, 4.3, 5.1, 5.2, 5.3]
    subtasks:
      - id: "6.1"
        priority: true
        title: 予約確認メール送信関数
        files:
          - path: src/lib/email/send-viewing-confirmation.ts
            action: create
        status: pending
      - id: "6.2"
        priority: true
        title: オペレーター通知メール送信関数
        files:
          - path: src/lib/email/send-viewing-notification.ts
            action: create
        status: pending
      - id: "6.3"
        priority: true
        title: リマインダーメール送信関数
        files:
          - path: src/lib/email/send-viewing-reminder.ts
            action: create
        status: pending
      - id: "6.4"
        priority: true
        title: キャンセルメール送信関数
        files:
          - path: src/lib/email/send-viewing-cancellation.ts
            action: create
        status: pending

  - id: 7
    title: キオスク完了API更新
    requirements: [1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4]
    files:
      - path: app/api/kiosk/complete/route.ts
        action: modify
    subtasks:
      - id: "7.1"
        title: POST /api/kiosk/complete拡張
        details:
          - 内見予約情報をリクエストボディに含める
          - ViewingService.createViewing()呼び出し
          - メール送信並列実行
          - ICS生成とメール添付
        status: pending

  - id: 8
    title: 予約管理API実装（オペレーター向け）
    requirements: [3.1, 3.2, 3.3, 3.4, 3.5, 4.1, 4.2]
    subtasks:
      - id: "8.1"
        title: GET /api/viewings実装
        files:
          - path: app/api/viewings/route.ts
            action: create
        status: pending
      - id: "8.2"
        title: GET /api/viewings/[id]実装
        files:
          - path: app/api/viewings/[id]/route.ts
            action: create
        status: pending
      - id: "8.3"
        title: PATCH /api/viewings/[id]実装
        status: pending
      - id: "8.4"
        title: DELETE /api/viewings/[id]実装
        status: pending
      - id: "8.5"
        title: GET /api/viewings/[id]/conversation実装
        files:
          - path: app/api/viewings/[id]/conversation/route.ts
            action: create
        status: pending

  - id: 9
    title: オペレーター向けフロントエンド実装
    requirements: [3.1, 3.2, 3.3, 3.4, 3.5]
    subtasks:
      - id: "9.1"
        priority: true
        title: ViewingFilterコンポーネント
        files:
          - path: src/components/features/viewings/ViewingFilter.tsx
            action: create
        status: pending
      - id: "9.2"
        priority: true
        title: ViewingCardコンポーネント
        files:
          - path: src/components/features/viewings/ViewingCard.tsx
            action: create
        status: pending
      - id: "9.3"
        title: ViewingListコンポーネント
        files:
          - path: src/components/features/viewings/ViewingList.tsx
            action: create
        status: pending
      - id: "9.4"
        priority: true
        title: ConversationHistoryコンポーネント
        files:
          - path: src/components/features/viewings/ConversationHistory.tsx
            action: create
        status: pending
      - id: "9.5"
        title: ViewingDetailコンポーネント
        files:
          - path: src/components/features/viewings/ViewingDetail.tsx
            action: create
        status: pending

  - id: 10
    title: オペレーター向けページ実装
    requirements: [3.1, 3.2, 3.3, 3.4, 3.5]
    subtasks:
      - id: "10.1"
        title: 予約一覧ページ
        files:
          - path: app/(operator)/viewings/page.tsx
            action: create
        status: pending
      - id: "10.2"
        title: 予約詳細ページ
        files:
          - path: app/(operator)/viewings/[id]/page.tsx
            action: create
        status: pending
      - id: "10.3"
        title: ナビゲーション追加
        files:
          - path: src/components/layout/OperatorNav.tsx
            action: modify
        status: pending

  - id: 11
    title: リマインダーCronジョブ実装
    requirements: [5.1, 5.2, 5.3]
    subtasks:
      - id: "11.1"
        title: リマインダー送信API実装
        files:
          - path: app/api/cron/viewing-reminders/route.ts
            action: create
        details:
          - 翌日の内見を検索
          - リマインダーメール送信
          - reminder_sentフラグ更新
        status: pending
      - id: "11.2"
        title: Vercel Cron設定
        files:
          - path: vercel.json
            action: modify
        details:
          - 毎日午前9時に実行
        status: pending
      - id: "11.3"
        title: Cronジョブのテスト
        status: pending

  - id: 12
    title: E2Eテストとドキュメント
    requirements: [All]
    subtasks:
      - id: "12.1"
        priority: true
        title: 統合テスト実装
        files:
          - path: app/api/viewings/__tests__/route.test.ts
            action: create
        status: pending
      - id: "12.2"
        priority: true
        title: E2Eテスト実装
        files:
          - path: e2e/viewings.spec.ts
            action: create
        status: pending
      - id: "12.3"
        priority: true
        title: 機能ドキュメント作成
        files:
          - path: .kiro/specs/viewing-reservation/implementation.md
            action: create
        status: pending
