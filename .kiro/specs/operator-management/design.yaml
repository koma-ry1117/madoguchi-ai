feature: operator-management
title: オペレーター管理設計

overview:
  purpose: システム管理者がオペレーター（不動産会社）を管理し、システム全体を監視する機能
  users: システム管理者（gyam様）のみ

goals:
  - オペレーターのライフサイクル管理
  - サブスクリプション管理
  - システム全体の可視化
  - 監査ログ

non_goals:
  - 課金・決済処理（外部システム）
  - 自動サブスクリプション更新

technology_stack:
  - component: Frontend
    choice: React 19 + Next.js 15
    role: 管理画面
  - component: UI
    choice: shadcn/ui + TanStack Table
    role: テーブル、フォーム
  - component: Charts
    choice: Recharts
    role: 統計グラフ
  - component: Auth
    choice: Supabase Auth
    role: 管理者認証
  - component: Database
    choice: Supabase PostgreSQL
    role: データ

invitation_flow:
  description: 管理者がオペレーターを登録すると、招待メールが送信され、オペレーター自身がパスワードを設定するフロー
  points:
    - 管理者はパスワードを設定しない（セキュリティ向上）
    - admin.inviteUserByEmail() で招待メール自動送信
    - オペレーターは自分でパスワードを設定
    - "招待メールの有効期限: 24時間"
    - 招待中のオペレーターは pending_activation ステータス

components:
  frontend:
    - name: OperatorList
      intent: オペレーター一覧テーブル
      requirements: [2]
      features:
        - ソート（会社名、作成日、ステータス）
        - フィルター（ステータス）
        - 検索（会社名）
        - ページネーション

    - name: OperatorForm
      intent: オペレーター登録・編集フォーム
      requirements: [1, 3]
      fields:
        - email: string
        - "# パスワードは不要（招待メールでオペレーター自身が設定）"
        - company_name: string
        - company_address: string?
        - phone: string?
        - subscription_plan: "'basic' | 'standard' | 'premium'"
        - subscription_status: "'active' | 'suspended' | 'cancelled' | 'trial' | 'pending_activation'"
        - contract_start_date: Date
        - contract_end_date: Date?
        - is_active: boolean

    - name: SystemStats
      intent: システム統計ダッシュボード
      requirements: [5]
      stats:
        - オペレーター数（状態別）
        - 物件数
        - 顧客数
        - 会話数（直近30日）

api_routes:
  - path: GET /api/admin/operators
    query_params:
      - { name: subscription_status, type: string, description: ステータスフィルター }
      - { name: is_active, type: boolean, description: 有効状態フィルター }
      - { name: search, type: string, description: 会社名検索 }
      - { name: page, type: number, description: ページ番号 }
      - { name: limit, type: number, description: 取得件数 }
    response:
      operators: "{ id, company_name, subscription_status, stats: { property_count, customer_count } }[]"
      pagination: { total, page }

  - path: POST /api/admin/operators
    description: 招待メール方式でオペレーターを登録（パスワード不要）
    request:
      email: string
      company_name: string
      company_address: string?
      phone: string?
      subscription_plan: string
      contract_start_date: string
    response:
      operator_id: uuid
      status: pending_activation
      invitation_sent: true
      message: 招待メールを送信しました

  - path: POST /api/admin/operators/[id]/resend-invitation
    description: 招待メールを再送信（有効期限切れ時など）
    response:
      message: 招待メールを再送信しました

  - path: PATCH /api/admin/operators/[id]
    request: { company_name?, subscription_status?, is_active? }

  - path: DELETE /api/admin/operators/[id]
    response:
      message: オペレーターを削除しました

  - path: GET /api/admin/stats
    response:
      operators: { total, active, suspended, cancelled }
      properties: { total, public }
      customers: { total }
      conversations: { total, last_30_days }

data_models:
  operator:
    fields:
      - id: string
      - user_id: string
      - company_name: string
      - company_address: string?
      - phone: string?
      - email: string
      - subscription_status: "'active' | 'suspended' | 'cancelled' | 'trial' | 'pending_activation'"
      - subscription_plan: "'basic' | 'standard' | 'premium'"
      - contract_start_date: Date
      - contract_end_date: Date?
      - is_active: boolean
      - invited_at: Date? # 招待メール送信日時
      - activated_at: Date? # パスワード設定完了日時
      - created_at: Date
      - updated_at: Date
    status_transition: "pending_activation → active → suspended → cancelled"

security:
  - 認証: admin roleのみアクセス可能
  - 権限チェック: 全APIでadmin権限を検証
  - 監査ログ: 重要な操作（作成、削除、ステータス変更）をログ

error_handling:
  - "403 Forbidden: admin以外のアクセス"
  - "404 Not Found: オペレーターが存在しない"
  - "409 Conflict: メールアドレス重複"

testing:
  unit:
    - "OperatorService: CRUD操作"
    - 権限チェック
  integration:
    - オペレーター登録→ユーザー作成
    - オペレーター削除→CASCADE確認
  e2e:
    - 登録→一覧表示→編集→削除
    - 統計表示
