feature: voice-io
title: 音声入出力実装タスク

phases:
  - name: "Phase 1: インフラ・API"
    parallel: true
    tasks: [1, 2, 3, 4, 5]
  - name: "Phase 2: 音声入力"
    depends_on: [4]
    tasks: [6, 7, 8]
  - name: "Phase 3: 音声出力"
    depends_on: [3, 5]
    tasks: [9, 10]
  - name: "Phase 4: UI統合"
    depends_on: [8, 10]
    tasks: [12, 13, 14]
  - name: "Phase 5: 最適化・テスト"
    parallel: true
    tasks: [11, 15, 16, 17]

tasks:
  - id: 1
    priority: true
    title: Supabase Storage バケット設定とライフサイクル管理
    requirements: [3.1, 3.3]
    files:
      - path: supabase/migrations/YYYYMMDDHHMMSS_create_audio_cache_bucket.sql
        action: create
    subtasks:
      - audio-cacheバケットをSupabase Storageに作成
      - RLSポリシーを設定（キオスクユーザーの読み取り許可）
      - ライフサイクル設定で30日後に自動削除
    status: pending

  - id: 2
    priority: true
    title: 音声キャッシュユーティリティ実装
    requirements: [3.1, 3.2, 3.4]
    files:
      - path: src/lib/utils/audio-cache.ts
        action: create
    subtasks:
      - SHA256ハッシュ関数を実装
      - キャッシュ取得関数（Supabase Storage）
      - キャッシュ保存関数（エラー時はサイレント失敗）
    status: pending

  - id: 3
    title: テキスト→音声変換APIルート（Google Cloud TTS + キャッシング）
    requirements: [2.1, 2.3, 3.2]
    files:
      - path: app/api/voice/synthesize/route.ts
        action: create
    subtasks:
      - POST /api/voice/synthesize エンドポイント作成
      - Google Cloud TTS API統合（ja-JP-Standard-A、MP3）
      - キャッシュロジック実装（HIT/MISSヘッダー）
      - エラーハンドリング
    status: pending

  - id: 4
    title: 音声→テキスト変換APIルート（OpenAI Whisper）
    requirements: [1.3]
    files:
      - path: app/api/voice/transcribe/route.ts
        action: create
    subtasks:
      - POST /api/voice/transcribe エンドポイント作成
      - OpenAI Whisper API呼び出し（whisper-1、ja）
      - エラーハンドリング（NO_SPEECH、API_ERROR）
      - レート制限（operator_idごと）
    status: pending

  - id: 5
    priority: true
    title: チャンク分割ユーティリティ実装
    requirements: [2]
    files:
      - path: src/lib/utils/text-chunking.ts
        action: create
      - path: src/lib/utils/__tests__/text-chunking.test.ts
        action: create
    subtasks:
      - splitIntoChunks関数を実装（。！？で分割）
      - 空白チャンクをフィルタリング
      - ユニットテスト追加
    status: pending

  - id: 6
    priority: true
    title: VoiceWaveformコンポーネント実装
    requirements: [1.2]
    files:
      - path: src/components/features/voice/VoiceWaveform.tsx
        action: create
    subtasks:
      - Web Audio API（AnalyserNode）使用
      - Canvas APIで波形描画
      - アニメーションループ（requestAnimationFrame）
    status: pending

  - id: 7
    title: useVoiceRecorder Hook実装
    requirements: [1.1, 1.5, 1.6]
    files:
      - path: src/lib/hooks/useVoiceRecorder.ts
        action: create
    subtasks:
      - MediaRecorder API使用
      - 録音時間制限（最大60秒）
      - マイク許可リクエスト
      - AnalyserNode生成（波形表示用）
    status: pending

  - id: 8
    title: VoiceInputコンポーネント実装（高齢者対応UI）
    requirements: [1.1, 1.2, 1.4]
    files:
      - path: src/components/features/voice/VoiceInput.tsx
        action: create
    subtasks:
      - 大きなマイクボタン（120px × 120px以上）
      - 録音中UI（VoiceWaveform、カウントダウン）
      - API呼び出し（/api/voice/transcribe）
      - エラーハンドリング
    status: pending

  - id: 9
    title: useAudioQueue Hook実装
    requirements: [2, 4.3]
    files:
      - path: src/lib/hooks/useAudioQueue.ts
        action: create
    subtasks:
      - 音声キュー管理（chunks、currentIndex、isPlaying）
      - enqueue（/api/voice/synthesize呼び出し）
      - play（キュー順次再生）
      - skip/stop（再生制御）
    status: pending

  - id: 10
    title: AudioPlayerコンポーネント実装
    requirements: [2.2, 4.1, 4.4]
    files:
      - path: src/components/features/voice/AudioPlayer.tsx
        action: create
    subtasks:
      - useAudioQueue Hook使用
      - スキップボタン
      - 再生/一時停止ボタン
      - 音量調整UI
    status: pending

  - id: 11
    priority: true
    title: 事前キャッシュスクリプト実装
    requirements: [3.4]
    files:
      - path: src/lib/utils/precache-phrases.ts
        action: create
      - path: scripts/precache-audio.ts
        action: create
    subtasks:
      - 事前キャッシュフレーズ定義（挨拶、確認、提案、予約）
      - 事前キャッシュスクリプト（並列リクエスト最大5並列）
      - 起動時実行設定
    status: pending

  - id: 12
    title: ChatInterfaceへの音声機能統合
    requirements: [1.4, 2.2, 2.5, 4.4]
    files:
      - path: src/components/features/chat/ChatInterface.tsx
        action: modify
    subtasks:
      - VoiceInput追加（テキスト入力の上部）
      - AudioPlayer追加（AI応答時）
      - アバター感情連携
      - 音声コントロール（新応答時に前音声停止）
    status: pending

  - id: 13
    title: キオスクUIへの音声機能統合
    requirements: [1, 2, 4]
    files:
      - path: src/components/features/kiosk/KioskInterface.tsx
        action: modify
    subtasks:
      - VoiceInputを画面中央に大きく配置
      - AudioPlayerを画面下部に配置
      - 音声とアバターの連動
      - レスポンシブ対応
    status: pending

  - id: 14
    title: エラーハンドリングとフォールバック実装
    requirements: [1, 2]
    files:
      - path: src/components/features/voice/VoiceInput.tsx
        action: modify
      - path: src/components/features/voice/AudioPlayer.tsx
        action: modify
    subtasks:
      - VoiceInputエラー（マイク拒否→テキスト入力フォールバック）
      - AudioPlayerエラー（TTS失敗→テキストのみ表示）
      - トースト通知UI
    status: pending

  - id: 15
    priority: true
    title: ユニットテスト実装
    requirements: [All]
    files:
      - path: src/lib/utils/__tests__/audio-cache.test.ts
        action: create
      - path: src/lib/utils/__tests__/text-chunking.test.ts
        action: create
      - path: src/lib/hooks/__tests__/useVoiceRecorder.test.ts
        action: create
      - path: src/lib/hooks/__tests__/useAudioQueue.test.ts
        action: create
    subtasks:
      - audio-cache.tsのテスト
      - text-chunking.tsのテスト
      - useVoiceRecorder Hookのテスト
      - useAudioQueue Hookのテスト
    status: pending

  - id: 16
    priority: true
    title: 統合テスト実装
    requirements: [All]
    files:
      - path: app/api/voice/__tests__/transcribe.test.ts
        action: create
      - path: app/api/voice/__tests__/synthesize.test.ts
        action: create
      - path: e2e/voice-flow.spec.ts
        action: create
    subtasks:
      - /api/voice/transcribe APIテスト
      - /api/voice/synthesize APIテスト
      - E2Eテスト（Playwright）
    status: pending

  - id: 17
    title: パフォーマンス最適化とモニタリング
    requirements: [2, 3]
    files:
      - path: src/lib/hooks/useAudioQueue.ts
        action: modify
      - path: src/lib/utils/performance-logger.ts
        action: create
    subtasks:
      - 並列TTSリクエスト実装（最大3並列）
      - キャッシュヒット率モニタリング（目標40%以上）
      - 体感待ち時間測定（目標50%削減）
      - パフォーマンスログ実装
    status: pending
