# Design Document

## Overview

**Purpose**: ã‚­ã‚ªã‚¹ã‚¯ç«¯æœ«ã§ã®éŸ³å£°ä¼šè©±ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æä¾›ã—ã€ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãŒè‹¦æ‰‹ãªé¡§å®¢ï¼ˆç‰¹ã«é«˜é½¢è€…ï¼‰ã§ã‚‚å¿«é©ã«ç‰©ä»¶ã‚’æ¢ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

**Users**: ã‚­ã‚ªã‚¹ã‚¯ç«¯æœ«ã‚’åˆ©ç”¨ã™ã‚‹åº—èˆ—æ¥åº—å®¢ï¼ˆèªè¨¼ä¸è¦ï¼‰

### Goals
- è‡ªç„¶ãªæ—¥æœ¬èªéŸ³å£°èªè­˜
- é«˜å“è³ªãªéŸ³å£°åˆæˆ
- ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ã®å¿œç­”
- ã‚³ã‚¹ãƒˆåŠ¹ç‡ã®è‰¯ã„ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°
- **é«˜é½¢è€…ã«ã‚‚ä½¿ã„ã‚„ã™ã„UI**: éŸ³å£°å…¥åŠ›ãƒœã‚¿ãƒ³ã‚’ç”»é¢ä¸­å¤®ã«å¤§ããé…ç½®

### Non-Goals
- å¤šè¨€èªå¯¾å¿œï¼ˆæ—¥æœ¬èªã®ã¿ï¼‰
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å­—å¹•ç”Ÿæˆ
- éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ç®¡ç†ç”»é¢ã§ã®éŸ³å£°æ©Ÿèƒ½ï¼ˆãƒ†ã‚­ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ã®ã¿ï¼‰

## Architecture

### System Components

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ã‚­ã‚ªã‚¹ã‚¯ç«¯æœ«ï¼ˆåº—èˆ—è¨­ç½®ï¼‰                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    VoiceInterface                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ VoiceInput  â”‚  â”‚ AudioPlayer â”‚  â”‚ VoiceWaveform   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ (Record)    â”‚  â”‚ (Playback)  â”‚  â”‚ (Visualization) â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                â”‚
             â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /api/voice/   â”‚  â”‚ POST /api/voice/   â”‚
â”‚ transcribe         â”‚  â”‚ synthesize         â”‚
â”‚                    â”‚  â”‚                    â”‚
â”‚ OpenAI Whisper API â”‚  â”‚ ElevenLabs API     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ + Supabase Cache   â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Technology Stack

| Layer | Choice / Version | Role |
|-------|------------------|------|
| Audio Recording | Web Audio API, MediaRecorder | ãƒ–ãƒ©ã‚¦ã‚¶éŸ³å£°éŒ²éŸ³ |
| STT | OpenAI Whisper API | éŸ³å£°â†’ãƒ†ã‚­ã‚¹ãƒˆ |
| TTS | ElevenLabs API | ãƒ†ã‚­ã‚¹ãƒˆâ†’éŸ³å£° |
| Cache | Supabase Storage | éŸ³å£°ã‚­ãƒ£ãƒƒã‚·ãƒ¥ |
| Audio Playback | HTML5 Audio API | éŸ³å£°å†ç”Ÿ |

## System Flows

### éŸ³å£°å…¥åŠ›ãƒ•ãƒ­ãƒ¼ï¼ˆã‚­ã‚ªã‚¹ã‚¯UIçµ±åˆï¼‰

```mermaid
sequenceDiagram
    participant U as ã‚­ã‚ªã‚¹ã‚¯åˆ©ç”¨è€…
    participant UI as VoiceInput
    participant Kiosk as KioskInterface
    participant API as /api/voice/transcribe
    participant W as OpenAI Whisper

    U->>UI: ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
    UI->>UI: MediaRecorderé–‹å§‹
    UI-->>U: æ³¢å½¢è¡¨ç¤ºï¼ˆéŒ²éŸ³ä¸­ï¼‰

    U->>UI: éŒ²éŸ³åœæ­¢ï¼ˆã¾ãŸã¯è‡ªå‹•åœæ­¢ï¼‰
    UI->>UI: Blobç”Ÿæˆ
    UI->>API: POST (audio file)
    API->>W: transcriptions.create()
    W-->>API: text
    API-->>UI: { text }
    UI->>Kiosk: onTranscribe(text)
    Kiosk->>Kiosk: AIä¼šè©±APIã«é€ä¿¡
```

### éŸ³å£°å‡ºåŠ›ãƒ•ãƒ­ãƒ¼ï¼ˆè‡ªå‹•å†ç”Ÿï¼‰

```mermaid
sequenceDiagram
    participant Kiosk as KioskInterface
    participant AP as AudioPlayer
    participant API as /api/voice/synthesize
    participant Cache as Supabase Storage
    participant E as ElevenLabs

    Kiosk->>AP: AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
    AP->>API: POST { text }
    API->>API: SHA256(text) â†’ hash
    API->>Cache: download(hash.mp3)

    alt Cache Hit
        Cache-->>API: audio data
    else Cache Miss
        API->>E: textToSpeech.convert()
        E-->>API: audio stream
        API->>Cache: upload(hash.mp3)
    end

    API-->>AP: audio/mpeg
    AP->>AP: Audio.play()
    AP-->>Kiosk: onPlayStart()
    Note over Kiosk: ã‚¢ãƒã‚¿ãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
    AP-->>Kiosk: onPlayEnd()
    Note over Kiosk: ã‚¢ãƒã‚¿ãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†
```

## Components and Interfaces

### Frontend Components

#### VoiceInputï¼ˆã‚­ã‚ªã‚¹ã‚¯å°‚ç”¨ï¼‰
| Field | Detail |
|-------|--------|
| Intent | éŸ³å£°éŒ²éŸ³ã¨ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ› |
| Requirements | 1 |

**UIè¨­è¨ˆï¼ˆé«˜é½¢è€…å¯¾å¿œï¼‰**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                         â”‚
â”‚                                                         â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚              â”‚                     â”‚                   â”‚
â”‚              â”‚    ğŸ¤               â”‚                   â”‚
â”‚              â”‚                     â”‚                   â”‚
â”‚              â”‚   ã‚¿ãƒƒãƒ—ã—ã¦        â”‚                   â”‚
â”‚              â”‚   ãŠè©±ã—ãã ã•ã„     â”‚                   â”‚
â”‚              â”‚                     â”‚                   â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                  (120px Ã— 120px)                       â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ [___ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›___]              [é€ä¿¡]        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¨­è¨ˆãƒã‚¤ãƒ³ãƒˆ**
- éŸ³å£°ãƒœã‚¿ãƒ³ã¯ç”»é¢ä¸­å¤®ã«å¤§ããé…ç½®ï¼ˆ120px Ã— 120pxä»¥ä¸Šï¼‰
- ãƒœã‚¿ãƒ³ã«ã¯ã€Œã‚¿ãƒƒãƒ—ã—ã¦ãŠè©±ã—ãã ã•ã„ã€ã®ãƒ©ãƒ™ãƒ«ã‚’è¡¨ç¤º
- éŒ²éŸ³ä¸­ã¯æ³¢å½¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤º
- ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã¯è£œåŠ©çš„ãªä½ç½®ï¼ˆä¸‹éƒ¨ã«å°ã•ãé…ç½®ï¼‰

**State**
```typescript
interface VoiceInputState {
  isRecording: boolean;
  audioBlob: Blob | null;
  isProcessing: boolean;
  recordingDuration: number;
}
```

**Props**
```typescript
interface VoiceInputProps {
  onTranscribe: (text: string) => void;
  disabled?: boolean;
  maxDuration?: number; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ60ç§’
  size?: 'large' | 'medium'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ'large'ï¼ˆã‚­ã‚ªã‚¹ã‚¯ç”¨ï¼‰
}
```

#### AudioPlayerï¼ˆã‚­ã‚ªã‚¹ã‚¯å°‚ç”¨ï¼‰
| Field | Detail |
|-------|--------|
| Intent | éŸ³å£°å†ç”Ÿã¨ã‚¢ãƒã‚¿ãƒ¼é€£æº |
| Requirements | 2, 4 |

**Props**
```typescript
interface AudioPlayerProps {
  text: string;
  autoPlay: boolean; // ã‚­ã‚ªã‚¹ã‚¯ã§ã¯å¸¸ã«true
  onPlayStart?: () => void;
  onPlayEnd?: () => void;
  onInterrupt?: () => void; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè©±ã—å§‹ã‚ãŸæ™‚
}
```

#### VoiceWaveform
| Field | Detail |
|-------|--------|
| Intent | éŒ²éŸ³ä¸­ã®æ³¢å½¢è¡¨ç¤º |
| Requirements | 1 |

**Props**
```typescript
interface VoiceWaveformProps {
  analyser: AnalyserNode | null;
  isRecording: boolean;
}
```

### API Routes

#### POST /api/voice/transcribe

èªè¨¼ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼ˆã‚­ã‚ªã‚¹ã‚¯ç”¨ï¼‰

**Request**: multipart/form-data
```
audio: File (webm/mp3)
operator_id: string (ãƒ¬ãƒ¼ãƒˆåˆ¶é™ç”¨)
```

**Response**
```json
{
  "success": true,
  "data": {
    "text": "æ–‡äº¬åŒºã§2LDKã®ç‰©ä»¶ã‚’æ¢ã—ã¦ã„ã¾ã™",
    "duration": 3.5,
    "language": "ja"
  }
}
```

#### POST /api/voice/synthesize

èªè¨¼ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼ˆã‚­ã‚ªã‚¹ã‚¯ç”¨ï¼‰

**Request**
```json
{
  "text": "ã‹ã—ã“ã¾ã‚Šã¾ã—ãŸã€‚æ–‡äº¬åŒºã§2LDKã®ç‰©ä»¶ã§ã™ã­ã€‚",
  "operator_id": "uuid"
}
```

**Response**: audio/mpeg (binary)

**Headers**
```
X-Cache-Status: HIT | MISS
Content-Type: audio/mpeg
```

## Data Models

### Audio Cache Key
```
audio-cache/{operator_id}/{sha256_hash}.mp3
```

### Supabase Storage Bucket
- Bucket: `audio-cache`
- Public: No
- Max file size: 5MB
- Allowed types: audio/mpeg
- Lifecycle: 30æ—¥å¾Œè‡ªå‹•å‰Šé™¤

### Pre-cached Phrasesï¼ˆäº‹å‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
```typescript
const PRECACHED_PHRASES = [
  "ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›ã€‚ä½•ã‹ãŠæ¢ã—ã§ã—ã‚‡ã†ã‹ï¼Ÿ",
  "ã‹ã—ã“ã¾ã‚Šã¾ã—ãŸã€‚",
  "å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚",
  "ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚",
  "ã¾ãŸã®ã”æ¥åº—ã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ã€‚",
];
```

## Error Handling

### Transcription Errors
- ãƒã‚¤ã‚¯è¨±å¯æ‹’å¦ â†’ ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã€è¨±å¯ã‚’ä¿ƒã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- éŒ²éŸ³å¤±æ•— â†’ å†è©¦è¡Œãƒœã‚¿ãƒ³è¡¨ç¤º
- Whisper APIã‚¨ãƒ©ãƒ¼ â†’ ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã‚’ä¿ƒã™
- ç„¡éŸ³æ¤œå‡º â†’ ã€ŒãŠè©±ãŒèãå–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

### Synthesis Errors
- ElevenLabs APIã‚¨ãƒ©ãƒ¼ â†’ ãƒ†ã‚­ã‚¹ãƒˆã®ã¿è¡¨ç¤ºï¼ˆéŸ³å£°ãªã—ï¼‰
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜å¤±æ•— â†’ ãƒ­ã‚°å‡ºåŠ›ï¼ˆã‚µã‚¤ãƒ¬ãƒ³ãƒˆå¤±æ•—ï¼‰
- éŸ³å£°å†ç”Ÿå¤±æ•— â†’ å†ç”Ÿãƒœã‚¿ãƒ³è¡¨ç¤º

## Testing Strategy

### Unit Tests
- VoiceInput: éŒ²éŸ³çŠ¶æ…‹ç®¡ç†
- AudioPlayer: å†ç”Ÿã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ç”Ÿæˆ

### Integration Tests
- /api/voice/transcribe: Whisper APIå‘¼ã³å‡ºã—
- /api/voice/synthesize: ElevenLabs + ã‚­ãƒ£ãƒƒã‚·ãƒ¥

### E2E Tests
- éŒ²éŸ³â†’å¤‰æ›â†’AIé€ä¿¡
- AIå¿œç­”â†’éŸ³å£°ç”Ÿæˆâ†’è‡ªå‹•å†ç”Ÿ

## Performance Considerations

- éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: æœ€å¤§5MB
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡ã®ç›£è¦–
- ElevenLabs ãƒ¬ãƒ¼ãƒˆåˆ¶é™: operator_idã”ã¨ã«ãƒ¬ãƒ¼ãƒˆåˆ¶é™
- éŒ²éŸ³æœ€å¤§æ™‚é–“: 60ç§’
- äº‹å‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥: ã‚ˆãä½¿ã†ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’èµ·å‹•æ™‚ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥
