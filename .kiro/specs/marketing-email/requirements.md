# Requirements Document

## Introduction

営業メール・キャンペーン機能は、オペレーター（不動産会社）が新着物件を既存顧客に効率的に配信し、フォローアップ営業を行うための機能です。物件連続追加時のメール重複送信防止、Resend連携による配信停止管理、失敗メールのリトライ機能を含みます。

## Requirements

### Requirement 1: 営業推奨ユーザー検索

**Objective:** As an オペレーター, I want 物件追加後に営業メールを送るべき顧客を検索できる機能, so that 連続で物件を追加してもメールが重複送信されることを防げる

#### Acceptance Criteria
1. When 物件が追加された時, システムは「営業推奨ユーザーを検索」ボタンを表示する
2. When 検索ボタンがクリックされた時, システムは物件条件にマッチする顧客を検索する
3. When 検索結果を表示する時, システムは直近N日以内にメール送信済みの顧客を除外する（デフォルト7日）
4. When 検索結果を表示する時, システムは配信停止リストに登録されている顧客を除外する
5. システムは検索結果のサマリー（条件マッチ数、除外数、最終配信対象数）を表示する
6. When オペレーターが配信対象を選択した時, システムは選択された顧客のみにメールを配信する

### Requirement 2: 新着物件配信キャンペーン

**Objective:** As an オペレーター, I want 新着物件を条件マッチする顧客に一括配信できる, so that 効率的に営業活動ができる

#### Acceptance Criteria
1. When キャンペーンを作成する時, オペレーターは対象物件、配信条件（エリア、予算等）を設定できる
2. When キャンペーンを作成する時, システムは配信対象者のプレビューを表示する
3. When 配信を実行する時, システムはメールをキューに登録し、バックグラウンドで順次送信する
4. システムは配信統計（送信数、開封数、クリック数、バウンス数）を記録する
5. When 配信が完了した時, システムはキャンペーンのステータスを「completed」に更新する

### Requirement 3: フォローアップ営業メール（リトライ）

**Objective:** As an オペレーター, I want 営業メール送信後に反応がない顧客へリトライメールを送りたい, so that 成約率を向上できる

#### Acceptance Criteria
1. When メール送信が失敗した時, システムは自動的にリトライキューに登録する
2. システムは最大3回までリトライを試みる
3. When リトライする時, システムは指数バックオフ（30分、1時間、2時間）で間隔を空ける
4. When 3回失敗した時, システムは最終失敗として記録し、オペレーターに通知する
5. オペレーターは失敗したメールを手動でリトライできる

### Requirement 4: Resend連携による配信停止管理

**Objective:** As a システム, I want Resendからのバウンス・苦情通知を受けて自動的に配信停止する, so that メール配信の品質を維持できる

#### Acceptance Criteria
1. When Resendからhard_bounceイベントを受信した時, システムはそのメールアドレスを恒久的に配信停止リストに追加する
2. When Resendからsoft_bounceイベントを受信した時, システムは7日間の一時的な配信停止を設定する
3. When Resendからspam_complaintイベントを受信した時, システムはそのメールアドレスを恒久的に配信停止リストに追加する
4. システムはResend Webhookの署名を検証する
5. When メールを送信する前に, システムは配信停止リストをチェックし、該当する場合はスキップする
6. When soft_bounceの期限が切れた時, システムは自動的に配信停止を解除する

### Requirement 5: 配信停止リスト管理

**Objective:** As an オペレーター, I want 配信停止リストを確認・管理できる, so that メール配信の状況を把握できる

#### Acceptance Criteria
1. オペレーターは自社の配信停止リストを一覧表示できる
2. システムは配信停止理由（hard_bounce、soft_bounce、spam_complaint、unsubscribe、manual）を表示する
3. オペレーターは手動で顧客を配信停止リストに追加できる
4. オペレーターは配信停止理由でフィルタリングできる
5. システムは配信停止日時とバウンス詳細情報を表示する
