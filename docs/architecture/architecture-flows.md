# アーキテクチャ - データフロー

> 本ドキュメントは [アーキテクチャ設計](../architecture.md) の一部です。

## 会話フロー（顧客 ↔ AI）

```
┌────────────┐
│  顧客      │
│ (Browser)  │
└──────┬─────┘
       │ 1. 音声入力/テキスト入力
       ▼
┌────────────────────────┐
│ フロントエンド          │
│                        │
│ 【音声の場合】          │
│ Web Audio API          │
│   → MediaRecorder      │
│   → Blob生成           │
└──────┬─────────────────┘
       │ 2. POST /api/voice/transcribe
       ▼
┌────────────────────────┐
│ Next.js API Route      │
│ /api/voice/transcribe  │
│                        │
│ OpenAI Whisper API呼出 │
└──────┬─────────────────┘
       │ 3. テキスト返却
       ▼
┌────────────────────────┐
│ フロントエンド          │
│ (テキスト確定)          │
└──────┬─────────────────┘
       │ 4. POST /api/chat (ストリーミング)
       ▼
┌────────────────────────────────────────┐
│ Next.js API Route                      │
│ /api/chat                              │
│                                        │
│ 1. 会話履歴をDBから取得                 │
│ 2. Vercel AI SDK + GPT-4o呼出          │
│ 3. Function Calling判定                │
│    - searchProperties() 実行           │
│    - getPropertyImages() 実行          │
│ 4. 感情分析（並列実行）                 │
│ 5. ストリーミングレスポンス              │
└──────┬─────────────────────────────────┘
       │ 5. Server-Sent Events (SSE)
       ▼
┌────────────────────────┐
│ フロントエンド          │
│                        │
│ 1. ストリーミング受信   │
│ 2. アバター表情更新     │
│ 3. メッセージ表示       │
└──────┬─────────────────┘
       │ 6. POST /api/voice/synthesize
       ▼
┌────────────────────────┐
│ Next.js API Route      │
│ /api/voice/synthesize  │
│                        │
│ 1. キャッシュ確認      │
│ 2. ElevenLabs API呼出  │
│ 3. Supabase保存        │
└──────┬─────────────────┘
       │ 7. 音声データ返却
       ▼
┌────────────────────────┐
│ フロントエンド          │
│                        │
│ HTML5 Audio API再生    │
└────────────────────────┘
```

---

## 物件取り込みフロー（Chrome拡張 → システム）

```
┌────────────────┐
│ オペレーター    │
│ (Browser)      │
└────┬───────────┘
     │ 1. アットホームで物件ページ表示
     ▼
┌────────────────────────┐
│ Chrome拡張機能         │
│                        │
│ 1. ポップアップ表示     │
│ 2. 「取り込み」ボタン   │
└────┬───────────────────┘
     │ 3. クリック
     ▼
┌────────────────────────┐
│ Content Script         │
│                        │
│ document.outerHTML取得 │
└────┬───────────────────┘
     │ 4. HTMLデータ
     ▼
┌────────────────────────┐
│ Background Service     │
│ Worker                 │
│                        │
│ Auth Token取得         │
└────┬───────────────────┘
     │ 5. POST /api/properties/import
     │    (HTML + URL + Auth Token)
     ▼
┌────────────────────────────────────────┐
│ Next.js API Route                      │
│ /api/properties/import                 │
│                                        │
│ 1. Auth Token検証（Supabase）          │
│ 2. 権限確認（operator or admin）       │
│ 3. GPT-4oで構造化データ抽出            │
│    {                                   │
│      title, address, rent, layout,     │
│      building_type, area, station,     │
│      distance_from_station, ...        │
│    }                                   │
│ 4. Supabaseに保存                      │
│    - properties テーブル               │
│    - property_import_logs テーブル     │
│ 5. HTMLスナップショットをStorage保存    │
└────┬───────────────────────────────────┘
     │ 6. 成功レスポンス
     ▼
┌────────────────────────┐
│ Chrome拡張機能         │
│                        │
│ 「取り込み完了」通知    │
└────────────────────────┘
```

---

## メール通知フロー（内見予約確定時）

```
┌────────────┐
│  顧客      │
│ (Browser)  │
└──────┬─────┘
       │ 1. 物件詳細ページで「内見予約」ボタンクリック
       ▼
┌────────────────────────┐
│ フロントエンド          │
│                        │
│ 内見予約フォーム表示    │
│ - 希望日時選択         │
│ - 連絡先入力           │
└──────┬─────────────────┘
       │ 2. POST /api/viewings
       │    { property_id, viewing_date, ... }
       ▼
┌────────────────────────────────────────┐
│ Next.js API Route                      │
│ /api/viewings                          │
│                                        │
│ 1. Auth Token検証                      │
│ 2. customer_id取得                     │
│ 3. viewingsテーブルに保存               │
│    - viewing_date                      │
│    - property_id                       │
│    - customer_id                       │
│    - status: 'confirmed'               │
└──────┬─────────────────────────────────┘
       │ 3. 内見予約作成成功
       ▼
┌────────────────────────────────────────┐
│ メール送信処理（並列実行）              │
│                                        │
│ 1. カレンダー招待生成                   │
│    ical-generator                      │
│    → calendar.ics ファイル              │
│                                        │
│ 2. React Emailテンプレート作成          │
│    <ViewingConfirmationEmail />        │
│    → 美しいHTMLメール                   │
└──────┬─────────────────────────────────┘
       │ 4. Resend API呼出
       ▼
┌────────────────────────────────────────┐
│ Resend API                             │
│                                        │
│ resend.emails.send({                   │
│   from: 'madoguchi-ai <noreply@...>',  │
│   to: customer.email,                  │
│   subject: '内見予約が確定しました',    │
│   react: <ViewingConfirmationEmail />, │
│   attachments: [{ calendar.ics }]      │
│ })                                     │
└──────┬─────────────────────────────────┘
       │ 5. 並列送信
       ├────────────┬────────────┐
       │            │            │
       ▼            ▼            ▼
  【顧客宛】   【オペレーター宛】 【DB記録】
       │            │            │
  内見予約      内見予約通知    email_logs
  確定メール     メール         テーブルに
  + .ics添付    + .ics添付     送信記録保存
```

---

## 新着物件配信・営業メールフロー

```
【オペレーター】
       │
       │ 1. 物件追加完了
       ▼
┌────────────────────────────────────────┐
│ 物件管理画面                            │
│                                        │
│  ✅ 物件「文京区2LDK」を追加しました    │
│                                        │
│  [営業推奨ユーザーを検索] ボタン        │
│                                        │
└────────┬───────────────────────────────┘
         │
         │ 2. ボタンクリック
         ▼
┌────────────────────────────────────────┐
│ 営業推奨ユーザー検索API                  │
│                                        │
│ 検索条件:                              │
│ ・希望エリア: 文京区                    │
│ ・予算: 物件価格±20%                   │
│ ・直近7日以内メール送信済み → 除外      │
│ ・配信停止リスト → 除外                │
└────────┬───────────────────────────────┘
         │
         │ 3. 配信対象者プレビュー表示
         ▼
┌────────────────────────────────────────┐
│ 配信対象者確認画面                       │
│                                        │
│ 条件マッチ: 45名                        │
│ 除外（最近送信済み）: 12名              │
│ 除外（配信停止）: 3名                   │
│ ─────────────────                      │
│ 最終配信対象: 30名                      │
│                                        │
│ □ 山田太郎 (yamada@...) - 文京区希望    │
│ ☑ 佐藤花子 (sato@...) - 文京区希望     │
│ ☑ 鈴木一郎 (suzuki@...) - 千代田区希望  │
│ ...                                    │
│                                        │
│ [選択した顧客に配信] [キャンセル]       │
└────────┬───────────────────────────────┘
         │
         │ 4. 配信実行
         ▼
┌────────────────────────────────────────┐
│ メールキューに登録                       │
│                                        │
│ marketing_email_queue                  │
│ ・status: queued                       │
│ ・priority: 100                        │
│ ・retry_count: 0                       │
└────────┬───────────────────────────────┘
         │
         │ 5. バックグラウンドで順次送信
         ▼
         Resend API → 顧客に配信
```

---

## Resend Webhookによる配信停止フロー

```
【顧客のメールサーバー】
         │
         │ バウンス発生 / スパム報告
         ▼
┌────────────────────────────────────────┐
│ Resend                                 │
│                                        │
│ イベント検出:                           │
│ ・email.bounced (宛先不明)             │
│ ・email.complained (スパム報告)        │
└────────┬───────────────────────────────┘
         │
         │ Webhook送信
         ▼
┌────────────────────────────────────────┐
│ POST /api/webhooks/resend              │
│                                        │
│ 1. 署名検証                            │
│ 2. イベント種別判定                     │
│ 3. 配信停止リストに追加                 │
└────────┬───────────────────────────────┘
         │
         │ 処理
         ▼
┌────────────────────────────────────────┐
│ email_suppressions テーブル             │
│                                        │
│ ・email: bounced@example.com           │
│ ・reason: hard_bounce                  │
│ ・bounce_type: permanent               │
│ ・expires_at: NULL (恒久停止)          │
│                                        │
│ ※ soft_bounceの場合は7日後に自動解除   │
└────────────────────────────────────────┘
         │
         │ 以降のメール送信時
         ▼
┌────────────────────────────────────────┐
│ メール送信前チェック                     │
│                                        │
│ if (isSuppressed(email)) {             │
│   skip(); // 配信スキップ              │
│ }                                      │
└────────────────────────────────────────┘
```

---

## 営業メールリトライフロー

```
【メール送信失敗】
         │
         │ 一時的なエラー（サーバーダウン等）
         ▼
┌────────────────────────────────────────┐
│ email_logs                             │
│ ・status: failed                       │
│ ・error_message: "..."                 │
└────────┬───────────────────────────────┘
         │
         │ 自動リトライ or 手動リトライ
         ▼
┌────────────────────────────────────────┐
│ marketing_email_queue                  │
│                                        │
│ ・retry_count: 1                       │
│ ・next_retry_at: +30分後               │
│ ・max_retries: 3                       │
└────────┬───────────────────────────────┘
         │
         │ 30分後
         ▼
┌────────────────────────────────────────┐
│ 再送信処理                              │
│                                        │
│ while (retry_count < max_retries) {    │
│   if (send() === success) break;       │
│   retry_count++;                       │
│   wait(exponential_backoff);           │
│ }                                      │
└────────┬────────────────┬──────────────┘
         │                │
       成功              失敗（3回）
         │                │
         ▼                ▼
    status: sent     status: failed
                     (最終失敗として記録)
```
