# ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

## ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå±¤                                  â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Webãƒ–ãƒ©ã‚¦ã‚¶      â”‚              â”‚ Chromeæ‹¡å¼µæ©Ÿèƒ½     â”‚        â”‚
â”‚  â”‚                  â”‚              â”‚ (ç‰©ä»¶å–ã‚Šè¾¼ã¿)      â”‚        â”‚
â”‚  â”‚  - Next.js UI    â”‚              â”‚                   â”‚        â”‚
â”‚  â”‚  - React 19      â”‚              â”‚  Manifest V3      â”‚        â”‚
â”‚  â”‚  - Tailwind CSS  â”‚              â”‚  TypeScript       â”‚        â”‚
â”‚  â”‚  - shadcn/ui     â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â”‚                  â”‚                        â”‚                  â”‚
â”‚  â”‚  ã€éŸ³å£°å…¥åŠ›ã€‘     â”‚                        â”‚ POST /api/       â”‚
â”‚  â”‚  Web Audio API   â”‚                        â”‚ properties/importâ”‚
â”‚  â”‚  MediaRecorder   â”‚                        â”‚                  â”‚
â”‚  â”‚                  â”‚                        â–¼                  â”‚
â”‚  â”‚  ã€ã‚¢ãƒã‚¿ãƒ¼è¡¨ç¤ºã€‘ â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  Framer Motion   â”‚              â”‚ Auth Tokenæ¤œè¨¼  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚             â”‚                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”‚ HTTPS
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Vercel Edge Network (CDN + Edge Functions)        â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Edge Middleware                                         â”‚   â”‚
â”‚  â”‚  - ãƒ¬ãƒ¼ãƒˆåˆ¶é™                                             â”‚   â”‚
â”‚  â”‚  - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼                                   â”‚   â”‚
â”‚  â”‚  - èªè¨¼ãƒã‚§ãƒƒã‚¯                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Next.js App Router                                      â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚  - Server Components (RSC)                               â”‚   â”‚
â”‚  â”‚  - Server Actions                                        â”‚   â”‚
â”‚  â”‚  - Route Handlers (API Routes)                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                                      â”‚
        â–¼                                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase        â”‚                              â”‚  å¤–éƒ¨APIã‚µãƒ¼ãƒ“ã‚¹     â”‚
â”‚                  â”‚                              â”‚                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                              â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ PostgreSQL   â”‚ â”‚                              â”‚ â”‚ OpenAI API      â”‚ â”‚
â”‚ â”‚ + pgvector   â”‚ â”‚                              â”‚ â”‚ - GPT-4o        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                              â”‚ â”‚ - Whisper       â”‚ â”‚
â”‚                  â”‚                              â”‚ â”‚ - Embeddings    â”‚ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                              â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”‚ Auth (JWT)   â”‚ â”‚                              â”‚                     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                              â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                  â”‚                              â”‚ â”‚ ElevenLabs API  â”‚ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                              â”‚ â”‚ - TTS           â”‚ â”‚
â”‚ â”‚ Storage      â”‚ â”‚                              â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”‚ - ç‰©ä»¶ç”»åƒ    â”‚ â”‚                              â”‚                     â”‚
â”‚ â”‚ - éŸ³å£°cache  â”‚ â”‚                              â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ - HTMLä¿å­˜   â”‚ â”‚                              â”‚ â”‚ Resend API â­   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                              â”‚ â”‚ - ãƒ¡ãƒ¼ãƒ«é…ä¿¡     â”‚ â”‚
â”‚                  â”‚                              â”‚ â”‚ - React Email   â”‚ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                              â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”‚ Realtime     â”‚ â”‚                              â”‚                     â”‚
â”‚ â”‚ (WebSocket)  â”‚ â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 1. ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤ï¼ˆPresentation Layerï¼‰

**è²¬å‹™**: UIè¡¨ç¤ºã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›å‡¦ç†ã€ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

```
src/app/
â”œâ”€â”€ (auth)/              # èªè¨¼é–¢é€£ãƒšãƒ¼ã‚¸
â”‚   â”œâ”€â”€ login/
â”‚   â”œâ”€â”€ signup/
â”‚   â””â”€â”€ layout.tsx
â”œâ”€â”€ (customer)/          # é¡§å®¢å‘ã‘ãƒšãƒ¼ã‚¸
â”‚   â”œâ”€â”€ chat/
â”‚   â”œâ”€â”€ properties/
â”‚   â””â”€â”€ layout.tsx
â”œâ”€â”€ (operator)/          # ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼å‘ã‘ãƒšãƒ¼ã‚¸
â”‚   â”œâ”€â”€ dashboard/
â”‚   â”œâ”€â”€ import/
â”‚   â””â”€â”€ layout.tsx
â”œâ”€â”€ (admin)/             # ç®¡ç†è€…å‘ã‘ãƒšãƒ¼ã‚¸
â”‚   â”œâ”€â”€ dashboard/
â”‚   â”œâ”€â”€ users/
â”‚   â””â”€â”€ layout.tsx
â””â”€â”€ layout.tsx           # ãƒ«ãƒ¼ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

src/components/
â”œâ”€â”€ ui/                  # shadcn/uiã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”œâ”€â”€ features/
â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â”œâ”€â”€ ChatInterface.tsx
â”‚   â”‚   â”œâ”€â”€ VoiceInput.tsx
â”‚   â”‚   â””â”€â”€ MessageList.tsx
â”‚   â”œâ”€â”€ avatar/
â”‚   â”‚   â”œâ”€â”€ Avatar.tsx
â”‚   â”‚   â””â”€â”€ EmotionSelector.tsx
â”‚   â””â”€â”€ properties/
â”‚       â”œâ”€â”€ PropertyCard.tsx
â”‚       â”œâ”€â”€ PropertyList.tsx
â”‚       â””â”€â”€ PropertyFilter.tsx
â””â”€â”€ layouts/
    â”œâ”€â”€ Header.tsx
    â”œâ”€â”€ Sidebar.tsx
    â””â”€â”€ Footer.tsx
```

### 2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ï¼ˆApplication Layerï¼‰

**è²¬å‹™**: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã€APIå‘¼ã³å‡ºã—ã€çŠ¶æ…‹ç®¡ç†

```
src/lib/
â”œâ”€â”€ hooks/               # ã‚«ã‚¹ã‚¿ãƒ React Hooks
â”‚   â”œâ”€â”€ useChat.ts
â”‚   â”œâ”€â”€ useVoice.ts
â”‚   â”œâ”€â”€ useProperties.ts
â”‚   â””â”€â”€ useAuth.ts
â”œâ”€â”€ stores/              # ZustandçŠ¶æ…‹ç®¡ç†
â”‚   â”œâ”€â”€ chatStore.ts
â”‚   â”œâ”€â”€ avatarStore.ts
â”‚   â”œâ”€â”€ authStore.ts
â”‚   â””â”€â”€ uiStore.ts
â””â”€â”€ services/            # ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
    â”œâ”€â”€ chatService.ts
    â”œâ”€â”€ propertyService.ts
    â”œâ”€â”€ voiceService.ts
    â””â”€â”€ authService.ts
```

### 3. ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£å±¤ï¼ˆInfrastructure Layerï¼‰

**è²¬å‹™**: å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹é€£æºã€ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹

```
src/lib/
â”œâ”€â”€ api/                 # API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ openai.ts
â”‚   â”œâ”€â”€ elevenlabs.ts
â”‚   â”œâ”€â”€ resend.ts       # â­ NEW
â”‚   â””â”€â”€ supabase.ts
â”œâ”€â”€ db/                  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹
â”‚   â”œâ”€â”€ queries/
â”‚   â”‚   â”œâ”€â”€ properties.ts
â”‚   â”‚   â”œâ”€â”€ customers.ts
â”‚   â”‚   â”œâ”€â”€ viewings.ts # â­ NEW
â”‚   â”‚   â””â”€â”€ conversations.ts
â”‚   â””â”€â”€ mutations/
â”‚       â”œâ”€â”€ properties.ts
â”‚       â”œâ”€â”€ viewings.ts # â­ NEW
â”‚       â””â”€â”€ conversations.ts
â”œâ”€â”€ email/              # â­ NEW ãƒ¡ãƒ¼ãƒ«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
â”‚   â”œâ”€â”€ templates/
â”‚   â”‚   â”œâ”€â”€ ViewingConfirmationEmail.tsx
â”‚   â”‚   â”œâ”€â”€ InquiryConfirmationEmail.tsx
â”‚   â”‚   â””â”€â”€ SystemAnnouncementEmail.tsx
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ generateICS.ts
â”‚       â””â”€â”€ sendEmail.ts
â””â”€â”€ utils/               # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    â”œâ”€â”€ embedding.ts
    â”œâ”€â”€ vectorSearch.ts
    â””â”€â”€ cache.ts
```

### 4. ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ï¼ˆDomain Layerï¼‰

**è²¬å‹™**: ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

```
src/types/
â”œâ”€â”€ property.ts          # ç‰©ä»¶ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
â”œâ”€â”€ customer.ts          # é¡§å®¢ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
â”œâ”€â”€ conversation.ts      # ä¼šè©±ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
â””â”€â”€ auth.ts              # èªè¨¼ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£

src/schemas/             # Zodã‚¹ã‚­ãƒ¼ãƒ
â”œâ”€â”€ propertySchema.ts
â”œâ”€â”€ customerSchema.ts
â””â”€â”€ conversationSchema.ts
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å›³

### ä¼šè©±ãƒ•ãƒ­ãƒ¼ï¼ˆé¡§å®¢ â†” AIï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é¡§å®¢      â”‚
â”‚ (Browser)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
       â”‚ 1. éŸ³å£°å…¥åŠ›/ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰          â”‚
â”‚                        â”‚
â”‚ ã€éŸ³å£°ã®å ´åˆã€‘          â”‚
â”‚ Web Audio API          â”‚
â”‚   â†’ MediaRecorder      â”‚
â”‚   â†’ Blobç”Ÿæˆ           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 2. POST /api/voice/transcribe
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Next.js API Route      â”‚
â”‚ /api/voice/transcribe  â”‚
â”‚                        â”‚
â”‚ OpenAI Whisper APIå‘¼å‡º â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 3. ãƒ†ã‚­ã‚¹ãƒˆè¿”å´
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰          â”‚
â”‚ (ãƒ†ã‚­ã‚¹ãƒˆç¢ºå®š)          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 4. POST /api/chat (ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Next.js API Route                      â”‚
â”‚ /api/chat                              â”‚
â”‚                                        â”‚
â”‚ 1. ä¼šè©±å±¥æ­´ã‚’DBã‹ã‚‰å–å¾—                 â”‚
â”‚ 2. Vercel AI SDK + GPT-4oå‘¼å‡º          â”‚
â”‚ 3. Function Callingåˆ¤å®š                â”‚
â”‚    - searchProperties() å®Ÿè¡Œ           â”‚
â”‚    - getPropertyImages() å®Ÿè¡Œ          â”‚
â”‚ 4. æ„Ÿæƒ…åˆ†æï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰                 â”‚
â”‚ 5. ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 5. Server-Sent Events (SSE)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰          â”‚
â”‚                        â”‚
â”‚ 1. ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å—ä¿¡   â”‚
â”‚ 2. ã‚¢ãƒã‚¿ãƒ¼è¡¨æƒ…æ›´æ–°     â”‚
â”‚ 3. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 6. POST /api/voice/synthesize
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Next.js API Route      â”‚
â”‚ /api/voice/synthesize  â”‚
â”‚                        â”‚
â”‚ 1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª      â”‚
â”‚ 2. ElevenLabs APIå‘¼å‡º  â”‚
â”‚ 3. Supabaseä¿å­˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 7. éŸ³å£°ãƒ‡ãƒ¼ã‚¿è¿”å´
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰          â”‚
â”‚                        â”‚
â”‚ HTML5 Audio APIå†ç”Ÿ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç‰©ä»¶å–ã‚Šè¾¼ã¿ãƒ•ãƒ­ãƒ¼ï¼ˆChromeæ‹¡å¼µ â†’ ã‚·ã‚¹ãƒ†ãƒ ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼    â”‚
â”‚ (Browser)      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 1. ã‚¢ãƒƒãƒˆãƒ›ãƒ¼ãƒ ã§ç‰©ä»¶ãƒšãƒ¼ã‚¸è¡¨ç¤º
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Chromeæ‹¡å¼µæ©Ÿèƒ½         â”‚
â”‚                        â”‚
â”‚ 1. ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º     â”‚
â”‚ 2. ã€Œå–ã‚Šè¾¼ã¿ã€ãƒœã‚¿ãƒ³   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 3. ã‚¯ãƒªãƒƒã‚¯
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Content Script         â”‚
â”‚                        â”‚
â”‚ document.outerHTMLå–å¾— â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 4. HTMLãƒ‡ãƒ¼ã‚¿
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Background Service     â”‚
â”‚ Worker                 â”‚
â”‚                        â”‚
â”‚ Auth Tokenå–å¾—         â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 5. POST /api/properties/import
     â”‚    (HTML + URL + Auth Token)
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Next.js API Route                      â”‚
â”‚ /api/properties/import                 â”‚
â”‚                                        â”‚
â”‚ 1. Auth Tokenæ¤œè¨¼ï¼ˆSupabaseï¼‰          â”‚
â”‚ 2. æ¨©é™ç¢ºèªï¼ˆoperator or adminï¼‰       â”‚
â”‚ 3. GPT-4oã§æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿æŠ½å‡º            â”‚
â”‚    {                                   â”‚
â”‚      title, address, rent, layout,     â”‚
â”‚      building_type, area, station,     â”‚
â”‚      distance_from_station, ...        â”‚
â”‚    }                                   â”‚
â”‚ 4. Supabaseã«ä¿å­˜                      â”‚
â”‚    - properties ãƒ†ãƒ¼ãƒ–ãƒ«               â”‚
â”‚    - property_import_logs ãƒ†ãƒ¼ãƒ–ãƒ«     â”‚
â”‚ 5. HTMLã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’Storageä¿å­˜    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 6. æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Chromeæ‹¡å¼µæ©Ÿèƒ½         â”‚
â”‚                        â”‚
â”‚ ã€Œå–ã‚Šè¾¼ã¿å®Œäº†ã€é€šçŸ¥    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ãƒ•ãƒ­ãƒ¼ï¼ˆå†…è¦‹äºˆç´„ç¢ºå®šæ™‚ï¼‰ â­ NEW

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é¡§å®¢      â”‚
â”‚ (Browser)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
       â”‚ 1. ç‰©ä»¶è©³ç´°ãƒšãƒ¼ã‚¸ã§ã€Œå†…è¦‹äºˆç´„ã€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰          â”‚
â”‚                        â”‚
â”‚ å†…è¦‹äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º    â”‚
â”‚ - å¸Œæœ›æ—¥æ™‚é¸æŠ         â”‚
â”‚ - é€£çµ¡å…ˆå…¥åŠ›           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 2. POST /api/viewings
       â”‚    { property_id, viewing_date, ... }
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Next.js API Route                      â”‚
â”‚ /api/viewings                          â”‚
â”‚                                        â”‚
â”‚ 1. Auth Tokenæ¤œè¨¼                      â”‚
â”‚ 2. customer_idå–å¾—                     â”‚
â”‚ 3. viewingsãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜               â”‚
â”‚    - viewing_date                      â”‚
â”‚    - property_id                       â”‚
â”‚    - customer_id                       â”‚
â”‚    - status: 'confirmed'               â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 3. å†…è¦‹äºˆç´„ä½œæˆæˆåŠŸ
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ¡ãƒ¼ãƒ«é€ä¿¡å‡¦ç†ï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰              â”‚
â”‚                                        â”‚
â”‚ 1. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ‹›å¾…ç”Ÿæˆ                   â”‚
â”‚    ical-generator                      â”‚
â”‚    â†’ calendar.ics ãƒ•ã‚¡ã‚¤ãƒ«              â”‚
â”‚                                        â”‚
â”‚ 2. React Emailãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ          â”‚
â”‚    <ViewingConfirmationEmail />        â”‚
â”‚    â†’ ç¾ã—ã„HTMLãƒ¡ãƒ¼ãƒ«                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 4. Resend APIå‘¼å‡º
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Resend API                             â”‚
â”‚                                        â”‚
â”‚ resend.emails.send({                   â”‚
â”‚   from: 'madoguchi-ai <noreply@madoguchi-ai.jp>',â”‚
â”‚   to: customer.email,                  â”‚
â”‚   subject: 'å†…è¦‹äºˆç´„ãŒç¢ºå®šã—ã¾ã—ãŸ',    â”‚
â”‚   react: <ViewingConfirmationEmail />, â”‚
â”‚   attachments: [{ calendar.ics }]      â”‚
â”‚ })                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 5. ä¸¦åˆ—é€ä¿¡
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚            â”‚            â”‚
       â–¼            â–¼            â–¼
  ã€é¡§å®¢å®›ã€‘   ã€ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼å®›ã€‘ ã€DBè¨˜éŒ²ã€‘
       â”‚            â”‚            â”‚
  å†…è¦‹äºˆç´„      å†…è¦‹äºˆç´„é€šçŸ¥    email_logs
  ç¢ºå®šãƒ¡ãƒ¼ãƒ«     ãƒ¡ãƒ¼ãƒ«         ãƒ†ãƒ¼ãƒ–ãƒ«ã«
  + .icsæ·»ä»˜    + .icsæ·»ä»˜     é€ä¿¡è¨˜éŒ²ä¿å­˜
       â”‚            â”‚            â”‚
       â–¼            â–¼            â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚é¡§å®¢ã®    â”‚  â”‚ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼â”‚  â”‚ãƒ»é€ä¿¡æ—¥æ™‚â”‚
  â”‚ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹â”‚  â”‚ã®ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹â”‚  â”‚ãƒ»é€ä¿¡å…ˆ â”‚
  â”‚          â”‚  â”‚          â”‚  â”‚ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹â”‚
  â”‚ğŸ“§ğŸ“     â”‚  â”‚ğŸ“§ğŸ“     â”‚  â”‚ãƒ»ã‚¨ãƒ©ãƒ¼ â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰

### Atomic Design ãƒ‘ã‚¿ãƒ¼ãƒ³

```
src/components/
â”œâ”€â”€ ui/ (Atoms)
â”‚   â”œâ”€â”€ button.tsx
â”‚   â”œâ”€â”€ input.tsx
â”‚   â”œâ”€â”€ card.tsx
â”‚   â”œâ”€â”€ avatar.tsx
â”‚   â”œâ”€â”€ badge.tsx
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ features/ (Molecules)
â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â”œâ”€â”€ MessageBubble.tsx
â”‚   â”‚   â”œâ”€â”€ VoiceButton.tsx
â”‚   â”‚   â””â”€â”€ TypingIndicator.tsx
â”‚   â”œâ”€â”€ avatar/
â”‚   â”‚   â”œâ”€â”€ AvatarDisplay.tsx
â”‚   â”‚   â””â”€â”€ EmotionIndicator.tsx
â”‚   â””â”€â”€ properties/
â”‚       â”œâ”€â”€ PropertyCard.tsx
â”‚       â”œâ”€â”€ PropertyImage.tsx
â”‚       â””â”€â”€ PropertyPrice.tsx
â”‚
â””â”€â”€ layouts/ (Organisms)
    â”œâ”€â”€ ChatInterface.tsx
    â”œâ”€â”€ PropertyList.tsx
    â”œâ”€â”€ DashboardLayout.tsx
    â””â”€â”€ Header.tsx
```

### ãƒšãƒ¼ã‚¸æ§‹æˆï¼ˆApp Routerï¼‰

```
app/
â”œâ”€â”€ layout.tsx                    # ãƒ«ãƒ¼ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
â”œâ”€â”€ page.tsx                      # ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸
â”‚
â”œâ”€â”€ (auth)/                       # èªè¨¼ã‚°ãƒ«ãƒ¼ãƒ—
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â””â”€â”€ signup/
â”‚       â””â”€â”€ page.tsx
â”‚
â”œâ”€â”€ (customer)/                   # é¡§å®¢ã‚°ãƒ«ãƒ¼ãƒ—
â”‚   â”œâ”€â”€ layout.tsx               # é¡§å®¢ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â””â”€â”€ page.tsx             # AIä¼šè©±ãƒšãƒ¼ã‚¸
â”‚   â”œâ”€â”€ properties/
â”‚   â”‚   â”œâ”€â”€ page.tsx             # ç‰©ä»¶ä¸€è¦§
â”‚   â”‚   â””â”€â”€ [id]/
â”‚   â”‚       â””â”€â”€ page.tsx         # ç‰©ä»¶è©³ç´°
â”‚   â””â”€â”€ history/
â”‚       â””â”€â”€ page.tsx             # ä¼šè©±å±¥æ­´
â”‚
â”œâ”€â”€ (operator)/                   # ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ import/
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â””â”€â”€ inquiries/
â”‚       â””â”€â”€ page.tsx
â”‚
â”œâ”€â”€ (admin)/                      # ç®¡ç†è€…ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆgyamæ§˜å°‚ç”¨ï¼‰
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â””â”€â”€ page.tsx              # ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
â”‚   â”œâ”€â”€ operators/                # â­ NEW ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆä¸å‹•ç”£ä¼šç¤¾ï¼‰ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ page.tsx              # ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ä¸€è¦§
â”‚   â”‚   â”œâ”€â”€ [id]/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx          # ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼è©³ç´°ãƒ»ç·¨é›†
â”‚   â”‚   â””â”€â”€ create/
â”‚   â”‚       â””â”€â”€ page.tsx          # æ–°è¦ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ç™»éŒ²
â”‚   â”œâ”€â”€ users/
â”‚   â”‚   â””â”€â”€ page.tsx              # å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
â”‚   â””â”€â”€ properties/
â”‚       â””â”€â”€ page.tsx              # å…¨ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ç‰©ä»¶é–²è¦§
â”‚
â””â”€â”€ api/                          # API Routes
    â”œâ”€â”€ chat/
    â”‚   â””â”€â”€ route.ts
    â”œâ”€â”€ voice/
    â”‚   â”œâ”€â”€ transcribe/
    â”‚   â”‚   â””â”€â”€ route.ts
    â”‚   â””â”€â”€ synthesize/
    â”‚       â””â”€â”€ route.ts
    â”œâ”€â”€ properties/
    â”‚   â”œâ”€â”€ import/
    â”‚   â”‚   â””â”€â”€ route.ts
    â”‚   â””â”€â”€ search/
    â”‚       â””â”€â”€ route.ts
    â”œâ”€â”€ viewings/                # â­ NEW
    â”‚   â”œâ”€â”€ route.ts            # POST (create), GET (list)
    â”‚   â””â”€â”€ [id]/
    â”‚       â””â”€â”€ route.ts        # PATCH (update/cancel)
    â”œâ”€â”€ emails/                  # â­ NEW
    â”‚   â”œâ”€â”€ send/
    â”‚   â”‚   â””â”€â”€ route.ts        # POST (send email)
    â”‚   â””â”€â”€ logs/
    â”‚       â””â”€â”€ route.ts        # GET (email logs - admin only)
    â””â”€â”€ admin/                   # â­ NEW ç®¡ç†è€…å°‚ç”¨API
        â”œâ”€â”€ operators/
        â”‚   â”œâ”€â”€ route.ts        # GET (list), POST (create)
        â”‚   â””â”€â”€ [id]/
        â”‚       â””â”€â”€ route.ts    # GET (detail), PATCH (update), DELETE
        â””â”€â”€ stats/
            â””â”€â”€ route.ts        # GET (ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®çµ±è¨ˆ)
```

---

## çŠ¶æ…‹ç®¡ç†æˆ¦ç•¥

### Zustandï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆçŠ¶æ…‹ï¼‰

```typescript
// src/lib/stores/chatStore.ts
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface Message {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  timestamp: Date;
}

interface ChatStore {
  messages: Message[];
  isLoading: boolean;
  addMessage: (message: Message) => void;
  setLoading: (loading: boolean) => void;
  clearMessages: () => void;
}

export const useChatStore = create<ChatStore>()(
  persist(
    (set) => ({
      messages: [],
      isLoading: false,
      addMessage: (message) =>
        set((state) => ({ messages: [...state.messages, message] })),
      setLoading: (loading) => set({ isLoading: loading }),
      clearMessages: () => set({ messages: [] }),
    }),
    {
      name: 'chat-storage',
      partialize: (state) => ({ messages: state.messages }),
    }
  )
);
```

### TanStack Queryï¼ˆã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹ï¼‰

```typescript
// src/lib/hooks/useProperties.ts
import { useQuery } from '@tanstack/react-query';
import { searchProperties } from '@/lib/services/propertyService';

export const useProperties = (filters: PropertyFilters) => {
  return useQuery({
    queryKey: ['properties', filters],
    queryFn: () => searchProperties(filters),
    staleTime: 5 * 60 * 1000, // 5åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    cacheTime: 10 * 60 * 1000, // 10åˆ†é–“ä¿æŒ
    refetchOnWindowFocus: false,
  });
};
```

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### èªè¨¼ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
       â”‚ 1. ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Next.js             â”‚
â”‚ Server Action       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 2. Supabase Authå‘¼å‡º
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase Auth      â”‚
â”‚                    â”‚
â”‚ 1. èªè¨¼æƒ…å ±æ¤œè¨¼    â”‚
â”‚ 2. JWTç™ºè¡Œ         â”‚
â”‚ 3. Refresh Tokenç™ºè¡Œâ”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 3. JWT + Refresh Token
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Next.js             â”‚
â”‚                    â”‚
â”‚ Cookieè¨­å®š         â”‚
â”‚ (httpOnly, secure) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 4. ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Row Level Securityï¼ˆRLSï¼‰

ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆæ§‹é€ ã«ã‚ˆã‚‹å³æ ¼ãªãƒ‡ãƒ¼ã‚¿åˆ†é›¢

```sql
-- operators ãƒ†ãƒ¼ãƒ–ãƒ«
-- ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼šè‡ªç¤¾æƒ…å ±ã®ã¿é–²è¦§ãƒ»æ›´æ–°
-- ç®¡ç†è€…ï¼šå…¨ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼æƒ…å ±ã‚’ç®¡ç†

-- properties ãƒ†ãƒ¼ãƒ–ãƒ«
-- é¡§å®¢ï¼šè‡ªåˆ†ãŒæ‰€å±ã™ã‚‹ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ã®å…¬é–‹ç‰©ä»¶ã®ã¿é–²è¦§
CREATE POLICY "customer_view_own_operator_properties"
ON properties FOR SELECT
TO authenticated
USING (
  is_public = true
  AND operator_id IN (
    SELECT operator_id FROM customers WHERE user_id = auth.uid()
  )
  AND (SELECT role FROM auth.users WHERE id = auth.uid()) = 'customer'
);

-- ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼šè‡ªç¤¾ã®ç‰©ä»¶ã®ã¿ç®¡ç†
CREATE POLICY "operator_manage_own_properties"
ON properties FOR ALL
TO authenticated
USING (
  operator_id IN (
    SELECT id FROM operators WHERE user_id = auth.uid()
  )
  AND (SELECT role FROM auth.users WHERE id = auth.uid()) = 'operator'
);

-- ç®¡ç†è€…ï¼šã™ã¹ã¦ã®ç‰©ä»¶ã‚’é–²è¦§ãƒ»ç®¡ç†
CREATE POLICY "admin_all"
ON properties FOR ALL
TO authenticated
USING (
  (SELECT role FROM auth.users WHERE id = auth.uid()) = 'admin'
);

-- customers ãƒ†ãƒ¼ãƒ–ãƒ«
-- ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼šè‡ªç¤¾ã®é¡§å®¢ã®ã¿ç®¡ç†
-- ç®¡ç†è€…ï¼šå…¨é¡§å®¢ã‚’é–²è¦§ï¼ˆç›£æŸ»ç”¨ï¼‰

-- conversations / messages ãƒ†ãƒ¼ãƒ–ãƒ«
-- ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼šè‡ªç¤¾ã®é¡§å®¢ã®ä¼šè©±ã®ã¿é–²è¦§
-- ç®¡ç†è€…ï¼šå…¨ä¼šè©±ã‚’é–²è¦§ï¼ˆç›£æŸ»ç”¨ï¼‰
```

è©³ç´°ã¯ [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](./database-design.md#row-level-security-rlsè¨­å®š) ã‚’å‚ç…§

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–æˆ¦ç•¥

### 1. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æœ€é©åŒ–

#### ç”»åƒæœ€é©åŒ–
- Next.js Image ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½¿ç”¨
- WebPå½¢å¼ã¸ã®è‡ªå‹•å¤‰æ›
- é…å»¶èª­ã¿è¾¼ã¿ï¼ˆLazy Loadingï¼‰

#### ã‚³ãƒ¼ãƒ‰åˆ†å‰²
```typescript
// å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
const PropertyMap = dynamic(() => import('@/components/PropertyMap'), {
  loading: () => <Skeleton />,
  ssr: false,
});
```

#### React Server Components
```typescript
// app/properties/page.tsx
import { getProperties } from '@/lib/db/queries/properties';

export default async function PropertiesPage() {
  // ã‚µãƒ¼ãƒãƒ¼ã§ç›´æ¥DBå–å¾—
  const properties = await getProperties();

  return <PropertyList properties={properties} />;
}
```

### 2. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æœ€é©åŒ–

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªæœ€é©åŒ–
```sql
-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
CREATE INDEX idx_properties_area ON properties(area);
CREATE INDEX idx_properties_rent ON properties(rent);
CREATE INDEX idx_properties_layout ON properties(layout);

-- è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_properties_search
ON properties(area, rent, layout)
WHERE is_public = true;
```

#### ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥
```typescript
// Redisé¢¨ã®ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ï¼ˆVercel KVï¼‰
import { kv } from '@vercel/kv';

export async function getPropertiesWithCache(filters: PropertyFilters) {
  const cacheKey = `properties:${JSON.stringify(filters)}`;

  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª
  const cached = await kv.get(cacheKey);
  if (cached) return cached;

  // DBã‚¯ã‚¨ãƒª
  const properties = await searchProperties(filters);

  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜ï¼ˆ5åˆ†ï¼‰
  await kv.set(cacheKey, properties, { ex: 300 });

  return properties;
}
```

### 3. APIæœ€é©åŒ–

#### ãƒ¬ã‚¹ãƒãƒ³ã‚¹åœ§ç¸®
```typescript
// middleware.ts
import { NextResponse } from 'next/server';

export function middleware(request: NextRequest) {
  const response = NextResponse.next();
  response.headers.set('Content-Encoding', 'gzip');
  return response;
}
```

#### ãƒ¬ãƒ¼ãƒˆåˆ¶é™
```typescript
import { Ratelimit } from '@upstash/ratelimit';
import { kv } from '@vercel/kv';

const ratelimit = new Ratelimit({
  redis: kv,
  limiter: Ratelimit.slidingWindow(10, '10 s'),
});

export async function POST(request: Request) {
  const { success } = await ratelimit.limit(request.headers.get('x-forwarded-for'));

  if (!success) {
    return new Response('Too Many Requests', { status: 429 });
  }

  // ...å‡¦ç†
}
```

---

## ç›£è¦–ãƒ»ãƒ­ã‚®ãƒ³ã‚°ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚¨ãƒ©ãƒ¼ç›£è¦–ï¼ˆSentryï¼‰

```typescript
// sentry.client.config.ts
import * as Sentry from '@sentry/nextjs';

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  tracesSampleRate: 1.0,
  environment: process.env.NODE_ENV,
  integrations: [
    new Sentry.BrowserTracing(),
    new Sentry.Replay(),
  ],
});
```

### ãƒ­ã‚°åé›†ï¼ˆAxiomï¼‰

```typescript
import { Logger } from 'next-axiom';

export async function POST(request: Request) {
  const logger = new Logger();

  try {
    // å‡¦ç†
    logger.info('Property imported', { propertyId: 123 });
  } catch (error) {
    logger.error('Import failed', { error });
  } finally {
    await logger.flush();
  }
}
```

---

æ¬¡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](./database-design.md)
